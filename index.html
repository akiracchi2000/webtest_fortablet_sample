<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°å­¦å‹•ç”»è¬›åº§ï¼†ç¢ºèªãƒ†ã‚¹ãƒˆ</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        body {
            font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic", "Meiryo", "MS PGothic", sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
            background-color: #f4f4f4;
            color: #333;
            overflow: hidden;
            display: flex;
            flex-direction: row;
            height: 100vh;
            width: 100vw;
        }

        #left-panel {
            width: 35%;
            min-width: 150px;
            height: 100%;
            overflow-y: auto;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #resizer {
            width: 12px;
            background: #e0e0e0;
            cursor: col-resize;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-left: 1px solid #ccc;
            border-right: 1px solid #ccc;
        }

        #resizer::after {
            content: "||";
            color: #999;
            font-size: 10px;
            letter-spacing: 1px;
        }

        #resizer:hover {
            background: #d0d0d0;
        }

        #right-panel {
            flex: 1;
            height: 100%;
            position: relative;
            background-color: #fff;
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        #memo-toolbar {
            height: 50px;
            background: #eee;
            display: flex;
            align-items: center;
            padding: 0 10px;
            border-bottom: 1px solid #ccc;
            justify-content: flex-end;
        }

        #memo-pad {
            flex: 1;
            width: 100%;
            touch-action: none;
            cursor: crosshair;
        }

        .memo-btn {
            padding: 8px 16px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .memo-btn:hover {
            background: #f0f0f0;
        }

        /* --- å‹•ç”»ã‚¨ãƒªã‚¢ --- */
        #video-section {
            width: 100%;
            margin-bottom: 15px;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: block;
            /* åˆæœŸçŠ¶æ…‹ã¯è¡¨ç¤º */
        }

        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
        }

        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* --- å‹•ç”»åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ --- */
        .toggle-btn-area {
            margin-bottom: 20px;
        }

        .skip-btn,
        .show-video-btn {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            border: none;
            transition: opacity 0.2s;
        }

        .skip-btn {
            background: #666;
            color: #fff;
        }

        .show-video-btn {
            background: #fff;
            color: #007bff;
            border: 2px solid #007bff;
            display: none;
            font-weight: bold;
        }

        .skip-btn:hover,
        .show-video-btn:hover {
            opacity: 0.8;
        }

        /* --- ãƒ†ã‚¹ãƒˆã‚¨ãƒªã‚¢ --- */
        #quiz-container {
            background: #fff;
            padding: 20px 15px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.1s;
        }

        /* ä¸æ­£è§£æ™‚ã®æºã‚Œã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .shake {
            animation: shake 0.4s cubic-bezier(.36, .07, .19, .97) both;
        }

        @keyframes shake {

            10%,
            90% {
                transform: translate3d(-1px, 0, 0);
            }

            20%,
            80% {
                transform: translate3d(2px, 0, 0);
            }

            30%,
            50%,
            70% {
                transform: translate3d(-4px, 0, 0);
            }

            40%,
            60% {
                transform: translate3d(4px, 0, 0);
            }
        }

        h3 {
            margin-top: 0;
            color: #444;
            font-size: 1.1em;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        #question-area {
            font-size: clamp(0.9rem, 2vw, 1.25rem);
            margin-bottom: 20px;
            min-height: 50px;
            overflow-wrap: break-word;
            line-height: 1.8;
            text-align: left;
            padding: 0 5px;
            font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic", "Meiryo", "MS PGothic", sans-serif;
        }

        /* KaTeXã®ãƒ•ã‚©ãƒ³ãƒˆã‚’ã‚´ã‚·ãƒƒã‚¯ã§ä¸Šæ›¸ãï¼ˆæ•°å¼ã‚‚ã‚´ã‚·ãƒƒã‚¯èª¿ã«ãªã‚Šã¾ã™ï¼‰ */
        #question-area .katex {
            font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Yu Gothic", "Meiryo", "MS PGothic", sans-serif;
        }

        /* å…¥åŠ›è¡¨ç¤ºæ  */
        .input-container {
            background: #fdfdfd;
            border: 2px solid #ccc;
            border-radius: 8px;
            margin-bottom: 15px;
            padding: 5px 12px;
            text-align: right;
        }

        .input-container.active {
            border-color: #007bff;
        }

        /* ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ã¯é’æ  */

        #raw-input {
            font-size: 0.9em;
            color: #aaa;
            height: 1.2em;
            letter-spacing: 1px;
            margin-bottom: 2px;
        }

        #math-preview {
            font-size: 2em;
            height: 1.5em;
            color: #000;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
        }

        /* --- çµæœãƒ»è§£èª¬ãƒœãƒƒã‚¯ã‚¹ --- */
        #result-box {
            display: none;
            text-align: left;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .res-correct {
            background-color: #f6ffed;
            border: 1px solid #b7eb8f;
        }

        .res-correct .res-header {
            color: #52c41a;
        }

        .res-wrong {
            background-color: #fff1f0;
            border: 1px solid #ffccc7;
        }

        .res-wrong .res-header {
            color: #f5222d;
        }

        .res-header {
            font-weight: bold;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .res-body {
            font-size: 0.95em;
            line-height: 1.6;
            color: #444;
        }

        .res-ans-label {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
            display: block;
            border-top: 1px dashed #ccc;
            padding-top: 8px;
        }

        .res-correct-math {
            font-size: 1.4em;
            color: #d32f2f;
            margin-left: 5px;
        }

        /* çµæœãƒœãƒƒã‚¯ã‚¹å†…ã®ã€Œæ¬¡ã¸ã€ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
        .res-footer {
            margin-top: 15px;
            text-align: right;
            border-top: 1px dashed #ccc;
            padding-top: 10px;
        }

        .next-btn-in-box {
            background-color: #333;
            color: #fff;
            border: none;
            padding: 10px 25px;
            border-radius: 30px;
            font-size: 1em;
            cursor: pointer;
            font-weight: bold;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .next-btn-in-box:hover {
            background-color: #555;
        }

        /* --- ã‚­ãƒ¼ãƒ‘ãƒƒãƒ‰ --- */
        #keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            width: 100%;
        }

        .key-btn {
            padding: 10px 0;
            font-size: clamp(1rem, 4vw, 1.4em);
            border: none;
            border-radius: 8px;
            background-color: #f0f2f5;
            box-shadow: 0 4px #ced0d4;
            color: #333;
            cursor: pointer;
            touch-action: manipulation;
            transition: all 0.1s;
            min-width: 0;
            /* Flex/Grid child shrinking fix */
        }

        .key-btn:active {
            box-shadow: 0 2px #b0b3b8;
            transform: translateY(2px);
        }

        .btn-num {
            background-color: #fff;
            font-weight: bold;
            font-family: sans-serif;
        }

        .btn-op {
            background-color: #e4e6eb;
            font-weight: bold;
        }

        .btn-blue {
            background-color: #e7f5ff;
            color: #007bff;
            font-family: sans-serif;
            box-shadow: 0 4px #badbeb;
        }

        .btn-red {
            background-color: #ffeef0;
            color: #d32f2f;
            font-family: sans-serif;
            box-shadow: 0 4px #f5c2c7;
        }

        .grid-span-2 {
            grid-column: span 2;
        }

        .grid-span-2 {
            grid-column: span 2;
        }

        /* --- AIåˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            text-align: left;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        .ai-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .ai-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .api-key-btn {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 0.8em;
            background: #eee;
            border: 1px solid #ccc;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0.7;
        }

        .api-key-btn:hover {
            opacity: 1;
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #764ba2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div id="left-panel">
        <div id="video-section">
            <div class="video-container">
                <iframe src="https://www.youtube.com/embed/gHjJ_G-N_nU?si=dummy" title="Lecture Video"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen></iframe>
            </div>
        </div>

        <div class="toggle-btn-area">
            <button id="skip-btn" class="skip-btn" onclick="toggleVideo(false)">â–¼ å‹•ç”»ã‚’é–‰ã˜ã¦ãƒ†ã‚¹ãƒˆã¸</button>
            <button id="show-btn" class="show-video-btn" onclick="toggleVideo(true)">â–² å‹•ç”»è¬›ç¾©ã‚’ã‚‚ã†ä¸€åº¦è¦‹ã‚‹</button>
        </div>

        <div id="quiz-container">
            <h3>ç¢ºèªãƒ†ã‚¹ãƒˆï¼šç¬¬ <span id="q-number">1</span> å•</h3>

            <div id="question-area">èª­ã¿è¾¼ã¿ä¸­...</div>

            <div class="input-container" id="input-box">
                <div id="raw-input">ç­”ãˆã‚’å…¥åŠ›</div>
                <div id="math-preview"></div>
            </div>

            <div id="result-box"></div>

            <div id="keypad">
                <button class="key-btn btn-num" onclick="inputKey('7')">7</button>
                <button class="key-btn btn-num" onclick="inputKey('8')">8</button>
                <button class="key-btn btn-num" onclick="inputKey('9')">9</button>
                <button class="key-btn btn-red" onclick="deleteLast()">BS</button>

                <button class="key-btn btn-num" onclick="inputKey('4')">4</button>
                <button class="key-btn btn-num" onclick="inputKey('5')">5</button>
                <button class="key-btn btn-num" onclick="inputKey('6')">6</button>
                <button class="key-btn btn-op" onclick="inputKey('/')">/åˆ†</button>

                <button class="key-btn btn-num" onclick="inputKey('1')">1</button>
                <button class="key-btn btn-num" onclick="inputKey('2')">2</button>
                <button class="key-btn btn-num" onclick="inputKey('3')">3</button>
                <button class="key-btn btn-op" onclick="inputKey('âˆš')">âˆš</button>

                <button class="key-btn btn-num" onclick="inputKey('0')">0</button>
                <button class="key-btn btn-op" onclick="inputKey('Ï€')">Ï€</button>
                <button class="key-btn btn-op" onclick="inputKey('-')">-</button>
                <button class="key-btn btn-blue" onclick="submitAnswer()">æ±ºå®š</button>
            </div>
        </div>
    </div> <!-- End left-panel -->

    <div id="resizer"></div>

    <div id="right-panel">
        <div id="memo-toolbar">
            <button class="memo-btn" onclick="clearMemo()">ğŸ—‘ï¸ ãƒ¡ãƒ¢ã‚’æ¶ˆå»</button>
        </div>
        <canvas id="memo-pad"></canvas>
    </div>

    <!-- AIåˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="ai-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAiModal()">&times;</span>
            <h3>ğŸ¤– AIåˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h3>
            <div id="ai-content">
                <!-- ã“ã“ã«çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>

    <button class="api-key-btn" onclick="setApiKey()">ğŸ”‘ APIè¨­å®š</button>

    <script>
        // --- è¨­å®š ---
        const QUESTIONS_FILE = 'questions.json';
        const QUESTION_COUNT = 5; // 1å›ã«å‡ºé¡Œã™ã‚‹å•é¡Œæ•°

        // --- å‹•ç”»ã®è¡¨ç¤ºåˆ‡æ›¿ ---
        function toggleVideo(show) {
            const videoSection = document.getElementById('video-section');
            const skipBtn = document.getElementById('skip-btn');
            const showBtn = document.getElementById('show-btn');
            if (show) {
                videoSection.style.display = 'block';
                skipBtn.style.display = 'inline-block';
                showBtn.style.display = 'none';
            } else {
                videoSection.style.display = 'none';
                skipBtn.style.display = 'none';
                showBtn.style.display = 'inline-block';
            }
        }

        // --- åŠ¹æœéŸ³æ©Ÿèƒ½ (Web Audio API) ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'correct') { // æ­£è§£éŸ³: ã‚­ãƒ©ã‚­ãƒ©ç³»
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1046.5, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(1567.9, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.6);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.6);
            } else { // ä¸æ­£è§£éŸ³: ãƒ–ã‚¶ãƒ¼ç³»
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let allQuestions = [];
        let quizSet = [];
        let currentIndex = 0;
        let currentInput = "";

        // --- åˆæœŸåŒ– ---
        document.addEventListener("DOMContentLoaded", () => {
            loadQuestions();
        });

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadQuestions() {
            try {
                const response = await fetch(QUESTIONS_FILE);
                if (!response.ok) throw new Error("JSONèª­ã¿è¾¼ã¿å¤±æ•—");
                allQuestions = await response.json();
                setupQuizSet();
            } catch (error) {
                console.warn("å¤–éƒ¨ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®åˆ¶é™ãªã©ï¼‰ã€‚ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚");
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ãƒ‡ãƒ¼ã‚¿
                allQuestions = [
                    { question: "\\text{åŠå¾„}3\\text{cmã®å††ã®å‘¨ã®é•·ã•}", correct_answer: "6Ï€", explanation: "å††å‘¨ = $2\\pi r$ ãªã®ã§ã€$2 \\times \\pi \\times 3 = 6\\pi$ ã§ã™ã€‚" },
                    { question: "\\sqrt{3} \\times \\sqrt{12}", correct_answer: "6", explanation: "$\\sqrt{3 \\times 12} = \\sqrt{36} = 6$ ã§ã™ã€‚" },
                    { question: "1 - \\frac{2}{3}", correct_answer: "1/3", explanation: "$1 = \\frac{3}{3}$ ãªã®ã§ã€$\\frac{3}{3} - \\frac{2}{3} = \\frac{1}{3}$ ã§ã™ã€‚" }
                ];
                setupQuizSet();
            }
        }

        function setupQuizSet() {
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦å‡ºé¡Œ
            const shuffled = [...allQuestions].sort(() => 0.5 - Math.random());
            quizSet = shuffled.slice(0, QUESTION_COUNT);
            currentIndex = 0;
            showQuestion();
        }

        // --- è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ ---
        function showQuestion() {
            const qData = quizSet[currentIndex];
            document.getElementById('q-number').innerText = currentIndex + 1;

            // UIãƒªã‚»ãƒƒãƒˆ
            const resultBox = document.getElementById('result-box');
            resultBox.style.display = "none";
            resultBox.className = "";
            document.getElementById('keypad').style.pointerEvents = "auto";
            document.getElementById('keypad').style.opacity = "1";
            document.getElementById('input-box').classList.add('active');
            document.getElementById('quiz-container').classList.remove('shake');

            currentInput = "";
            updateDisplay();

            // å•é¡Œæ–‡æç”»
            katex.render(qData.question, document.getElementById('question-area'), { displayMode: true });
        }

        // ã‚­ãƒ¼å…¥åŠ›å‡¦ç†
        function inputKey(char) {
            if (currentInput.length > 15) return;
            currentInput += char;
            updateDisplay();
        }

        function deleteLast() {
            currentInput = currentInput.slice(0, -1);
            updateDisplay();
        }

        // ç”»é¢æ›´æ–°ã¨æ•°å¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
        function updateDisplay() {
            const rawDisplay = document.getElementById('raw-input');
            const previewDisplay = document.getElementById('math-preview');

            rawDisplay.innerText = currentInput === "" ? "ç­”ãˆã‚’å…¥åŠ›" : currentInput;
            if (currentInput === "") {
                previewDisplay.innerText = "";
                return;
            }
            let texString = parseInputToTex(currentInput);
            try {
                katex.render(texString, previewDisplay, { throwOnError: false });
            } catch (e) {
                previewDisplay.innerText = currentInput;
            }
        }

        // å…¥åŠ›æ–‡å­—ã‚’KaTeXç”¨ã«å¤‰æ›ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼
        function parseInputToTex(input) {
            let tex = input;
            tex = tex.replace(/Ï€/g, "\\pi");
            tex = tex.replace(/âˆš(\d+)/g, "\\sqrt{$1}");
            // æ•°å­—ã€Ï€ã€ãƒ«ãƒ¼ãƒˆã®åˆ†æ•°ã‚’å‡¦ç†ã™ã‚‹æ­£è¦è¡¨ç¾
            tex = tex.replace(/([0-9Ï€âˆš]+)\/([0-9Ï€âˆš]+)/g, "\\frac{$1}{$2}");
            return tex;
        }

        // --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
        function submitAnswer() {
            if (currentInput === "") return;

            const qData = quizSet[currentIndex];
            const resultBox = document.getElementById('result-box');

            // æ“ä½œãƒ­ãƒƒã‚¯
            document.getElementById('keypad').style.pointerEvents = "none";
            document.getElementById('keypad').style.opacity = "0.5";
            document.getElementById('input-box').classList.remove('active');

            const isCorrect = (currentInput === qData.correct_answer);
            let contentHTML = "";

            // æ¬¡ã¸ãƒœã‚¿ãƒ³ã®HTML
            const nextButtonHTML = `
                <div class="res-footer">
                    <button class="next-btn-in-box" onclick="nextQuestion()">æ¬¡ã®å•é¡Œã¸ â¯</button>
                </div>
            `;

            if (isCorrect) {
                // æ­£è§£æ™‚ã®æ¼”å‡º
                playSound('correct');
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });

                resultBox.className = "res-correct";
                contentHTML = `
                    <div class="res-header">âœ… æ­£è§£ï¼</div>
                    <div class="res-body">${qData.explanation}</div>
                    ${nextButtonHTML}
                `;
            } else {
                // ä¸æ­£è§£æ™‚ã®æ¼”å‡º
                playSound('wrong');
                document.getElementById('quiz-container').classList.add('shake');

                resultBox.className = "res-wrong";
                contentHTML = `
                    <div class="res-header">âŒ æ®‹å¿µ...</div>
                    <div class="res-body">
                        ${qData.explanation}
                        <span class="res-ans-label">æ­£è§£ã¯ï¼š<span class="res-correct-math" id="correct-display"></span></span>
                        <button class="ai-btn" onclick="analyzeError()">âœ¨ é–“é•ã„ã‚’AIåˆ†æ</button>
                    </div>
                    ${nextButtonHTML}
                `;
            }

            resultBox.innerHTML = contentHTML;

            // ä¸æ­£è§£ã®å ´åˆã€æ­£è§£ã®æ•°å¼ã‚’æç”»
            if (!isCorrect) {
                let correctTex = parseInputToTex(qData.correct_answer);
                katex.render(correctTex, document.getElementById('correct-display'));
            }

            // è§£èª¬æ–‡ã®ä¸­ã®æ•°å¼ ($...$) ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            renderMathInElement(resultBox, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "$", right: "$", display: false }
                ]
            });

            resultBox.style.display = "block";
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < quizSet.length) {
                showQuestion();
            } else {
                // å…¨å•çµ‚äº†æ™‚
                confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                playSound('correct');
                setTimeout(() => {
                    if (confirm("å…¨å•çµ‚äº†ï¼ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚\nã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¾ã™ã‹ï¼Ÿ")) {
                        location.reload();
                    }
                }, 1000);
            }
        }

        // --- ãƒ¡ãƒ¢å¸³æ©Ÿèƒ½ ---
        const canvas = document.getElementById('memo-pad');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        function resizeCanvas() {
            const parent = document.getElementById('right-panel');
            const toolbar = document.getElementById('memo-toolbar');
            if (parent && toolbar && canvas) {
                canvas.width = parent.clientWidth;
                canvas.height = parent.clientHeight - toolbar.clientHeight;

                // è¨­å®šãƒªã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã®ã§å†è¨­å®š
                ctx.lineJoin = 'round';
                ctx.lineCap = 'round';
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#000';
            }
        }

        window.addEventListener('resize', resizeCanvas);
        // åˆæœŸåŒ–æ™‚ã«å°‘ã—é…å»¶ã•ã›ã¦ã‚µã‚¤ã‚ºåˆã‚ã›ï¼ˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¢ºå®šå¾Œï¼‰
        setTimeout(resizeCanvas, 100);

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            let clientX, clientY;
            if (e.changedTouches) {
                clientX = e.changedTouches[0].clientX;
                clientY = e.changedTouches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            return {
                x: clientX - rect.left,
                y: clientY - rect.top
            };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getPos(e);
            lastX = pos.x;
            lastY = pos.y;
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault(); // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
            lastX = pos.x;
            lastY = pos.y;
        }

        function stopDrawing() {
            isDrawing = false;
        }

        // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆ
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆ
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing);

        function clearMemo() {
            if (confirm("ãƒ¡ãƒ¢ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ")) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }
        }

        // --- ãƒªã‚µã‚¤ã‚ºæ©Ÿèƒ½ ---
        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('left-panel');
        const rightPanel = document.getElementById('right-panel');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            // iframeã®ã‚¤ãƒ™ãƒ³ãƒˆå¹²æ¸‰ã‚’é˜²ã
            document.querySelectorAll('iframe').forEach(f => f.style.pointerEvents = 'none');
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const containerWidth = document.body.clientWidth;
            const newLeftWidth = (e.clientX / containerWidth) * 100;

            // æœ€å°ãƒ»æœ€å¤§å¹…ã®åˆ¶é™ (ä¾‹ãˆã° 20% ~ 80%)
            if (newLeftWidth > 20 && newLeftWidth < 80) {
                leftPanel.style.width = `${newLeftWidth}%`;
                // å³ãƒ‘ãƒãƒ«ã¯ flex: 1 ãªã®ã§è‡ªå‹•èª¿æ•´ã•ã‚Œã‚‹ãŒã€
                // Canvasã®ãƒªã‚µã‚¤ã‚ºãŒå¿…è¦
                resizeCanvas();
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = 'default';
                document.querySelectorAll('iframe').forEach(f => f.style.pointerEvents = 'auto');
                resizeCanvas(); // æœ€çµ‚èª¿æ•´
            }
        });

        // --- AIåˆ†ææ©Ÿèƒ½ ---
        function setApiKey() {
            const currentKey = localStorage.getItem('gemini_api_key') || "";
            const newKey = prompt("Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:", currentKey);
            if (newKey !== null) {
                localStorage.setItem('gemini_api_key', newKey);
                alert("APIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
            }
        }

        function closeAiModal() {
            document.getElementById('ai-modal').style.display = 'none';
        }

        async function analyzeError() {
            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                alert("AIåˆ†ææ©Ÿèƒ½ã‚’ä½¿ã†ã«ã¯APIã‚­ãƒ¼ã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚\nå·¦ä¸‹ã®ã€ŒğŸ”‘ APIè¨­å®šã€ã‹ã‚‰ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-content');
            modal.style.display = 'flex';
            content.innerHTML = '<div class="loading-spinner"></div><p style="text-align:center">ãƒ¡ãƒ¢ã‚’åˆ†æä¸­...</p>';

            // ç”»åƒãƒ‡ãƒ¼ã‚¿ã®å–å¾—
            const imageData = canvas.toDataURL("image/png").split(',')[1]; // Base64éƒ¨åˆ†ã®ã¿
            const qData = quizSet[currentIndex];

            const promptText = `
ã‚ãªãŸã¯æ•°å­¦ã®å®¶åº­æ•™å¸«ã§ã™ã€‚ä¸­å­¦ç”Ÿã®ç”Ÿå¾’ãŒå•é¡Œã‚’è§£ãã¾ã—ãŸãŒã€é–“é•ãˆã¦ã—ã¾ã„ã¾ã—ãŸã€‚
ä»¥ä¸‹ã®æƒ…å ±ã¨ã€æ·»ä»˜ã•ã‚ŒãŸæ‰‹æ›¸ããƒ¡ãƒ¢ã®ç”»åƒã‚’å…ƒã«ã€ç”Ÿå¾’ãŒã©ã“ã§é–“é•ãˆãŸã®ã‹ã€ã¾ãŸã¯ã©ã®ã‚ˆã†ãªè€ƒãˆé•ã„ã‚’ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã‹ã‚’åˆ†æã—ã€å„ªã—ãã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚
æ­£è§£ãã®ã‚‚ã®ã‚’æ•™ãˆã‚‹ã ã‘ã§ãªãã€æ¬¡ã«ã¤ãªãŒã‚‹ãƒ’ãƒ³ãƒˆã‚’é‡è¦–ã—ã¦ãã ã•ã„ã€‚

å•é¡Œ: ${qData.question}
æ­£è§£: ${qData.correct_answer}
è§£èª¬: ${qData.explanation}
`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: promptText },
                                { inline_data: { mime_type: "image/png", data: imageData } }
                            ]
                        }]
                    })
                });

                if (!response.ok) throw new Error("APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—");

                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;

                // Markdownã‚’ç°¡æ˜“HTMLå¤‰æ› (æ”¹è¡Œã¨å¤ªå­—ç¨‹åº¦)
                const formattedText = aiText
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');

                content.innerHTML = `<div style="line-height:1.6;">${formattedText}</div>`;

            } catch (error) {
                console.error(error);
                content.innerHTML = '<p style="color:red">åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
            }
        }
    </script>
</body>

</html>
