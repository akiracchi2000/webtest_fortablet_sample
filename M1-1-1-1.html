<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬1ç¯€-1 æ§˜ã€…ãªç”¨èªã®ãƒ†ã‚¹ãƒˆ (ãƒ©ãƒ³ãƒ€ãƒ 10é¡Œ)</title>

    <!-- KaTeXï¼ˆæ•°å¼è¡¨ç¤ºãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼‰ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ -->
    <script src="M1-1-1-1QD.js"></script>

    <style>
        /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
        :root {
            --bg-color: #f0f2f5;
            --text-color: #333;
            --panel-bg: #ffffff;
            --border-color: #ccc;
            --header-bg: #007bff;
            --header-text: #fff;
            --btn-bg: #fff;
            --btn-text: #333;
            --btn-hover: #dee2e6;
            --btn-active-bg: #007bff;
            --btn-active-text: #fff;
            --memo-bg: #ffffff;
            --overlay-bg: rgba(255, 255, 255, 0.9);
            --correct-color: #007bff;
            --incorrect-color: #dc3545;
            --correct-bg: #d4edda;
            --incorrect-bg: #f8d7da;
            --link-color: #007bff;
        }

        body.dark-mode {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --panel-bg: #1e1e1e;
            --border-color: #444;
            --header-bg: #1a1a1a;
            --header-text: #e0e0e0;
            --btn-bg: #2d2d2d;
            --btn-text: #e0e0e0;
            --btn-hover: #3d3d3d;
            --btn-active-bg: #bb86fc;
            --btn-active-text: #000;
            --memo-bg: #121212;
            --overlay-bg: rgba(30, 30, 30, 0.9);
            --correct-color: #66b0ff;
            --incorrect-color: #ff6b6b;
            --correct-bg: #1e4620;
            --incorrect-bg: #4c1d1d;
            --link-color: #8ab4f8;
        }

        html,
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            width: 100vw;
            height: 100vh;
            height: 100dvh;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: none;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- å·¦ãƒ‘ãƒãƒ«ï¼ˆã‚¯ã‚¤ã‚ºï¼‰ --- */
        #left-panel {
            flex: 0 0 50vw;
            width: 50vw;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            background-color: var(--panel-bg);
            transition: background-color 0.3s;
            overscroll-behavior: none;
            touch-action: pan-y;
            border-right: none;
        }

        /* --- ãƒªã‚µã‚¤ã‚¶ãƒ¼ï¼ˆå¢ƒç•Œç·šï¼‰ --- */
        #resizer {
            width: 10px;
            background-color: var(--border-color);
            cursor: col-resize;
            z-index: 100;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }

        #resizer:hover,
        #resizer.active {
            background-color: #007bff;
        }

        #resizer::after {
            content: "â‹®";
            color: #666;
            font-size: 1.2em;
            font-weight: bold;
        }

        /* --- å³ãƒ‘ãƒãƒ«ï¼ˆãƒ¡ãƒ¢ãƒ‘ãƒƒãƒ‰ï¼‰ --- */
        #right-panel {
            flex: 0 0 50vw;
            width: 50vw;
            height: 100%;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden;
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã«ã‚ˆã‚‹ä½™ç™½é˜²æ­¢ */
            background-color: var(--panel-bg);
            transition: background-color 0.3s;
            position: relative;
            display: flex;
            flex-direction: column;
            touch-action: none;
            overscroll-behavior: none;
        }

        #memo-toolbar {
            height: 50px;
            background: var(--panel-bg);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding: 0 15px;
            border-top: 1px solid var(--border-color);
            padding-bottom: env(safe-area-inset-bottom);
            height: auto;
            min-height: 50px;
            touch-action: manipulation;
            transition: background-color 0.3s, border-color 0.3s;
        }

        #memo-container {
            flex: 1;
            position: relative;
            cursor: crosshair;
            background: var(--memo-bg);
            /* å¤‰æ•°ã‚’ä½¿ç”¨ */
            margin: 0;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            touch-action: none;
            transition: background-color 0.3s;
        }

        #memo-pad {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        #memo-question-overlay {
            position: absolute;
            top: calc(10px + env(safe-area-inset-top));
            left: 10px;
            right: 10px;
            background: var(--overlay-bg);
            color: var(--text-color);
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            pointer-events: none;
            /* ãƒšãƒ³å…¥åŠ›ã‚’é‚ªé­”ã—ãªã„ã‚ˆã†ã« */
            display: none;
            z-index: 10;
            font-size: 0.9em;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        #eraser-cursor {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #555;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            pointer-events: none;
            display: none;
            transform: translate(-50%, -50%);
            z-index: 20;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
        }

        .tool-btn {
            background: var(--btn-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
            color: var(--btn-text);
            touch-action: manipulation;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .tool-btn:hover:not(:disabled) {
            background: var(--btn-hover);
        }

        .tool-btn.active {
            background: var(--btn-active-bg);
            color: var(--btn-active-text);
            border-color: var(--btn-active-bg);
        }

        /* --- ã‚¯ã‚¤ã‚ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« (æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´) --- */
        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 10px;
            text-align: center;
            border-radius: 5px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s, color 0.3s;
        }

        header h1 {
            margin: 0;
            color: inherit;
            /* è¦ªè¦ç´ ã®colorã‚’ç¶™æ‰¿ */
            font-size: 1.5em;
        }

        #quiz-container {
            min-height: 300px;
        }

        #progress-bar {
            width: 100%;
            height: 10px;
            background-color: var(--border-color);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 15px;
            transition: background-color 0.3s;
        }

        #progress {
            width: 0%;
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease-in-out;
        }

        #question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        #question-number {
            font-weight: bold;
            color: #007bff;
        }

        #score {
            font-weight: bold;
            color: #28a745;
        }

        #question-text {
            font-size: 1.2em;
            margin: 15px 0 25px 0;
            color: var(--text-color);
            transition: color 0.3s;
        }

        #options-container {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        #options-container.options-vertical {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .option-btn {
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--panel-bg);
            cursor: pointer;
            font-size: 1.0em;
            transition: all 0.3s;
            width: 100%;
            text-align: left;
            color: var(--text-color);
            touch-action: manipulation;
        }

        .option-btn:hover:not(:disabled) {
            background-color: var(--btn-hover);
            border-color: #007bff;
        }

        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
        }

        .option-btn.correct {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            font-weight: bold;
        }

        .option-btn.incorrect {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .option-btn.incorrect.selected {
            opacity: 1;
            border-width: 3px;
        }

        #show-options-btn {
            display: none;
            margin: 20px auto;
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            background-color: #17a2b8;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #show-options-btn:hover {
            background-color: #138496;
        }

        #feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
            border: 2px solid;
            background-color: var(--panel-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        #feedback.correct-feedback {
            background-color: var(--correct-bg);
            border-color: var(--correct-color);
            color: var(--text-color);
        }

        #feedback.incorrect-feedback {
            background-color: var(--incorrect-bg);
            border-color: var(--incorrect-color);
            color: var(--text-color);
        }

        .close-modal:hover,
        .close-modal:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        a {
            color: var(--link-color);
        }

        .speak-button {
            display: none;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            margin-left: 8px;
            padding: 2px 5px;
        }

        #next-btn,
        #results-btn {
            display: none;
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            float: right;
            margin-top: 20px;
            transition: background-color 0.3s;
            touch-action: manipulation;
        }

        #next-btn:hover,
        #results-btn:hover {
            background-color: #0056b3;
        }

        #results-container {
            text-align: center;
            font-size: 1.4em;
            display: none;
            color: var(--text-color);
            transition: color 0.3s;
        }

        #results-container h2 {
            color: #007bff;
        }

        #homepage-link {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 20px;
            background-color: #6c757d;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            font-size: 1.1em;
        }

        #homepage-link:hover {
            background-color: #5a6268;
        }

        /* AIåˆ†æãƒœã‚¿ãƒ³ */
        .ai-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .ai-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.4);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        }

        /* AIãƒãƒŠãƒ¼ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ï¼‰ */
        .ai-banner {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }

        .explanation-banner {
            background: linear-gradient(135deg, #28a745 0%, #218838 100%);
            color: #fff;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            display: inline-block;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            max-height: 80vh;
            overflow-y: auto;
            overscroll-behavior: none;
            touch-action: pan-y;
            text-align: left;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            position: relative;
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
        }

        /* Image Preview Modal */
        #image-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #image-preview-modal img {
            max-width: 90%;
            max-height: 70%;
            border: 2px solid #fff;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }

        #image-preview-modal .modal-controls {
            display: flex;
            gap: 15px;
        }

        #image-preview-modal button {
            padding: 10px 20px;
            font-size: 1em;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background 0.3s;
        }

        #image-preview-modal .close-btn {
            background: #6c757d;
            color: #fff;
        }

        #image-preview-modal .share-btn {
            background: #007bff;
            color: #fff;
        }

        #image-preview-modal .save-hint {
            color: #fff;
            margin-bottom: 15px;
            font-size: 1em;
            text-align: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 4px;
        }

        /* ===== è¿½åŠ ï¼šä¸æ­£è§£æ™‚ã®2æŠï¼ˆã‚„ã‚Šç›´ã™ï¼æ­£è§£ã‚’æ•™ãˆã¦ï¼‰ ===== */
        .wrong-decision-area {
            margin-top: 12px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .wrong-decision-btn {
            padding: 10px 18px;
            font-size: 1em;
        }

        .wrong-decision-note {
            margin-top: 8px;
            font-size: 0.85em;
            opacity: 0.8;
            text-align: center;
        }

        /* ===== è¿½åŠ ï¼šåŠ±ã¾ã—ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæ°—æŒã¡ã‚ˆã•UPï¼‰ ===== */
        #encouragement-under-question {
            margin: 12px auto 0 auto;
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px dashed var(--border-color);
            background: var(--panel-bg);
            font-size: 0.98em;
            text-align: center;
            max-width: 95%;
            opacity: 0.92;
        }
    </style>
</head>

<body>

    <!-- å·¦ãƒ‘ãƒãƒ«ï¼šã‚¯ã‚¤ã‚º -->
    <div id="left-panel">
        <header>
            <h1>ç¬¬1ç¯€-1 æ§˜ã€…ãªç”¨èª</h1>
            <div>
                <!-- <button id="fullscreen-toggle" class="tool-btn" onclick="toggleFullscreen()"
                    style="padding: 5px 10px; font-size: 1.2em;" title="ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ï¼ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³è§£é™¤">â›¶</button> -->
                <button id="dark-mode-toggle" class="tool-btn" onclick="toggleDarkMode()"
                    style="padding: 5px 10px; font-size: 1.2em;" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ï¼ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰">ğŸŒ™</button>
                <button id="resume-toggle" class="tool-btn" onclick="toggleResume()"
                    style="padding: 5px 10px; font-size: 1.2em; display: none;" title="é€”ä¸­ä¿å­˜æ©Ÿèƒ½ã®ON/OFF">ğŸ“‚</button>
                <button id="sound-toggle" class="tool-btn" onclick="toggleSound()"
                    style="padding: 5px 10px; font-size: 1.2em;" title="åŠ¹æœéŸ³ã®æœ‰ï¼ç„¡">ğŸ”Š</button>
            </div>
        </header>
        <main>
            <div id="quiz-container">
                <div id="progress-bar">
                    <div id="progress"></div>
                </div>
                <div id="question-header">
                    <span id="question-number"></span>
                    <span id="score"></span>
                </div>
                <h2 id="question-text"></h2>

                <div id="encouragement-under-question" style="display:none;"></div>

                <button id="answer-btn" class="tool-btn ai-btn"
                    style="display:block; margin: 20px auto; padding: 12px 30px; font-size: 1.2em;"
                    onclick="checkAnswerWithAI()">ğŸ¤–AIã‚«ã‚¬ãƒ¯å…ˆç”ŸğŸ¤–ã«æ·»å‰Šã—ã¦ã‚‚ã‚‰ã†</button>
                <div id="analyzing-indicator" style="display:none; text-align:center; margin: 10px 0;">
                    <span style="font-size: 2em;">ğŸ¤–</span> æ¡ç‚¹ä¸­...
                </div>

                <div id="options-container" style="display:none;"></div>

                <div id="feedback"></div>

                <button id="next-btn">æ¬¡ã®å•é¡Œã¸</button>
                <button id="results-btn">çµæœã‚’è¦‹ã‚‹</button>
            </div>

            <div id="results-container">
                <h2>ãƒ†ã‚¹ãƒˆçµ‚äº†ï¼</h2>
                <p id="score-text"></p>
                <p id="final-message"></p>

                <!-- çµæœé€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ  -->
                <!-- çµæœé€ä¿¡ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div
                    style="margin: 20px 0; padding: 15px; background: var(--panel-bg); border-radius: 8px; border: 1px solid var(--border-color);">
                    <p style="margin-bottom: 10px; font-size: 0.9em;">â€»åå‰ã¨GAS URLã¯ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
                    <button class="tool-btn" onclick="sendResults()" style="background-color: #28a745; color: white;">ğŸ“¤
                        å…ˆç”Ÿã«é€ä¿¡</button>
                    <p id="send-status" style="margin-top: 5px; font-size: 0.9em; color: var(--text-color);"></p>
                </div>

                <button id="retry-btn" style="display:none; margin: 10px auto; background-color: #ffc107; color: #000;"
                    class="tool-btn" onclick="retryIncorrect()">ğŸ”¥ é–“é•ãˆãŸå•é¡Œã ã‘ãƒªãƒˆãƒ©ã‚¤</button>
                <br>
                <a href="index.html" id="homepage-link">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a>
            </div>
        </main>
        <footer>
            <p>&copy; 2025 [é¦™å·äº®]</p>
        </footer>
    </div>

    <!-- ãƒªã‚µã‚¤ã‚¶ãƒ¼ -->
    <div id="resizer"></div>

    <!-- å³ãƒ‘ãƒãƒ«ï¼šãƒ¡ãƒ¢ãƒ‘ãƒƒãƒ‰ -->
    <div id="right-panel">
        <div id="memo-container">
            <div id="memo-question-overlay"></div>
            <div id="eraser-cursor"></div>
            <canvas id="memo-pad"></canvas>
        </div>
        <div id="memo-toolbar">
            <button class="tool-btn active" id="btn-pen" onclick="setTool('pen')">âœï¸ ãƒšãƒ³</button>
            <button class="tool-btn" id="btn-pen-red" onclick="setTool('pen-red')">ğŸ”´ èµ¤ãƒšãƒ³</button>
            <button class="tool-btn" id="btn-eraser" onclick="setTool('eraser')">ğŸ§½ æ¶ˆã—ã‚´ãƒ </button>
            <button class="tool-btn active" id="btn-pen-only" onclick="togglePenOnly()">ğŸ–Šï¸ ãƒšãƒ³ã®ã¿</button>
            <button class="tool-btn" onclick="undoMemo()">â†©ï¸ å…ƒã«æˆ»ã™</button>
            <span style="margin: 0 10px; color: #ccc;">|</span>
            <button class="tool-btn" id="btn-toggle-question" onclick="toggleQuestionOverlay()">ğŸ“– å•é¡Œã‚’è¡¨ç¤º</button>
            <button class="tool-btn" onclick="saveMemo()">ğŸ’¾ ç”»åƒä¿å­˜</button>
            <button class="tool-btn" onclick="clearMemo()">ğŸ—‘ï¸ ãƒ¡ãƒ¢ã‚’æ¶ˆå»</button>
        </div>
    </div>

    <!-- AIåˆ†æãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="ai-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-modal" onclick="closeAiModal()">&times;</span>
            <h3>ğŸ¤– AIã‚«ã‚¬ãƒ¯å…ˆç”Ÿã®åˆ†æ</h3>
            <div id="ai-content">
                <p>åˆ†æä¸­...</p>
            </div>
        </div>
    </div>

    <script>
        // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
        let quizData = [];
        let incorrectQuestions = []; // é–“é•ãˆãŸå•é¡Œã‚’æ ¼ç´
        let currentQuestionIndex = 0;
        let score = 0;
        let startTime; // é–‹å§‹æ™‚é–“
        let isSoundOn = true; // åŠ¹æœéŸ³ON/OFF
        let isDarkMode = false; // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ON/OFF
        let isResumeOn = false; // ãƒ¬ã‚¸ãƒ¥ãƒ¼ãƒ æ©Ÿèƒ½ON/OFF (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆOFF)
        let currentPenColor = '#000'; // ç¾åœ¨ã®ãƒšãƒ³ã®è‰²
        const synth = window.speechSynthesis;
        let currentUtterance = null;
        let audioCtx = null; // ã‚°ãƒ­ãƒ¼ãƒãƒ«AudioContext

        // --- ã‚­ãƒ£ãƒ³ãƒã‚¹é–¢é€£ ---
        // --- AIã®JSONã‚’å®‰å…¨ã«ãƒ‘ãƒ¼ã‚¹ï¼ˆ\subset ãªã©ã®ä¸æ­£ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚’è‡ªå‹•ä¿®å¾©ï¼‰ ---
        function parseAIJsonWithRepair(rawText) {
            if (!rawText) throw new Error("Empty AI response");

            const trimmed = rawText.trim();

            // ä½™è¨ˆãªå‰å¾Œæ–‡ãŒæ··ã–ã£ã¦ã‚‚æœ€åˆã® { ã‹ã‚‰æœ€å¾Œã® } ã‚’æ‹¾ã†
            const match = trimmed.match(/\{[\s\S]*\}/);
            let jsonStr = match ? match[0] : trimmed;

            // ã¾ãšç´ ç›´ã«ãƒ‘ãƒ¼ã‚¹
            try {
                return JSON.parse(jsonStr);
            } catch (e1) {
                // JSONã¨ã—ã¦ç„¡åŠ¹ãªãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã ã‘ã‚’ \\ ã«ä¿®å¾©
                // ä¾‹: "\subset" -> "\\subset"
                let repaired = jsonStr.replace(
                    /\\(?!["\\/bfnrtu]|u[0-9a-fA-F]{4})/g,
                    '\\\\'
                );

                try {
                    return JSON.parse(repaired);
                } catch (e2) {
                    // æœ€çµ‚ä¿é™ºï¼šå…¨éƒ¨ã® \ ã‚’ \\ ã«ï¼ˆå¤šå°‘è’ã„ãŒæ­¢è¡€ã«ãªã‚‹ï¼‰
                    repaired = jsonStr.replace(/\\/g, '\\\\');
                    return JSON.parse(repaired);
                }
            }
        }

        let canvas;
        let ctx;
        let isDrawing = false;
        let currentTool = 'pen'; // 'pen' or 'eraser'
        let memoHistory = []; // Undoç”¨å±¥æ­´
        let isPenOnlyMode = true; // ãƒšãƒ³ã®ã¿ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‘ãƒ¼ãƒ ãƒªã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ï¼‰

        document.addEventListener("DOMContentLoaded", function () {
            initAudioContext(); // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åˆæœŸåŒ–æº–å‚™
            initCanvas();
            setTimeout(resizeCanvas, 100); // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç¢ºå®šå¾Œã«å†èª¿æ•´
            initQuiz();
            // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                isDarkMode = true;
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-toggle').textContent = 'â˜€ï¸';
                currentPenColor = '#fff'; // ãƒšãƒ³ã®è‰²ã‚’ç™½ã«è¨­å®š
            }

            // ãƒ¬ã‚¸ãƒ¥ãƒ¼ãƒ è¨­å®šã‚’èª­ã¿è¾¼ã‚€ (ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–)
            // const savedResume = localStorage.getItem('resumeOn');
            // if (savedResume !== null) {
            //     isResumeOn = (savedResume === 'true');
            // }
            updateResumeButton();

            // å…¨ä½“ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ï¼ˆå·¦ãƒ‘ãƒãƒ«ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«ä»¥å¤–ï¼‰
            document.addEventListener('touchmove', function (e) {
                // å·¦ãƒ‘ãƒãƒ«ã€ãƒ¢ãƒ¼ãƒ€ãƒ«ã€ã¾ãŸã¯ãƒ„ãƒ¼ãƒ«ãƒãƒ¼å†…ã®è¦ç´ ï¼ˆãƒœã‚¿ãƒ³ãªã©ï¼‰ã§ã®æ“ä½œã¯è¨±å¯
                if (!e.target.closest('#left-panel') &&
                    !e.target.closest('.modal-content') &&
                    !e.target.closest('#memo-toolbar')) {
                    e.preventDefault();
                }
            }, { passive: false });


            // --- ç©æ¥µçš„ãªã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆé…å»¶å¯¾ç­–ï¼‰ ---
            document.addEventListener('touchstart', function (e) {
                if (e.target.closest('.option-btn') || e.target.closest('#next-btn') || e.target.closest('#results-btn')) {
                    if (isSoundOn) {
                        try {
                            const AudioContext = window.AudioContext || window.webkitAudioContext;
                            if (!audioCtx && AudioContext) {
                                audioCtx = new AudioContext();
                            }
                            if (audioCtx && audioCtx.state === 'suspended') {
                                audioCtx.resume();
                            }
                        } catch (err) {
                            console.error("Audio warmup failed:", err);
                        }
                    }
                }
            }, { passive: true });
        });

        // --- ã‚¯ã‚¤ã‚ºåˆæœŸåŒ– ---
        function initQuiz() {
            // KaTeXè¨­å®š
            const katexDelimiters = [
                { left: '$$', right: '$$', display: true },
                { left: '$', right: '$', display: false },
                { left: '\\(', right: '\\)', display: false },
                { left: '\\[', right: '\\]', display: true }
            ];
            const renderMath = () => {
                if (window.renderMathInElement) {
                    renderMathInElement(document.body, { delimiters: katexDelimiters, throwOnError: false });
                } else {
                    setTimeout(renderMath, 100);
                }
            };
            renderMath();

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ (window.QUIZ_DATA from M1-1-1-1QD.js)
            let allData = [];
            if (window.QUIZ_DATA) {
                allData = window.QUIZ_DATA;
            } else if (typeof allQuizData !== 'undefined') {
                allData = allQuizData; // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            }

            if (!allData || allData.length === 0) {
                document.getElementById('question-text').innerText = "å•é¡Œãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
                return;
            }

            // ãƒ¬ã‚¸ãƒ¥ãƒ¼ãƒ æ©Ÿèƒ½ï¼šä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèª
            const urlParams = new URLSearchParams(window.location.search);
            const isReset = urlParams.get('reset') === 'true';

            if (isReset) {
                // index.htmlã‹ã‚‰æ¥ãŸå ´åˆãªã©ã¯ãƒªã‚»ãƒƒãƒˆï¼ˆç¢ºèªãªã—ã§æœ€åˆã‹ã‚‰ï¼‰
                // URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ã€ãƒªãƒ­ãƒ¼ãƒ‰æ™‚ã¯ãƒ¬ã‚¸ãƒ¥ãƒ¼ãƒ ãŒåŠ¹ãã‚ˆã†ã«ã™ã‚‹
                const newUrl = window.location.pathname + window.location.hash;
                window.history.replaceState(null, '', newUrl);
            } else if (isResumeOn) {
                const savedData = localStorage.getItem('quiz_progress_M1-1-1-1');
                if (savedData) {
                    if (confirm("å‰å›ã®ç¶šãã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ")) {
                        restoreProgress(JSON.parse(savedData));
                        return;
                    } else {
                        localStorage.removeItem('quiz_progress_M1-1-1-1'); // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãŸã‚‰å‰Šé™¤
                    }
                }
            }

            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¦10å•æŠ½å‡º
            const shuffled = [...allData].sort(() => 0.5 - Math.random());
            quizData = shuffled.slice(0, 10);

            startTime = Date.now(); // ã‚¿ã‚¤ãƒãƒ¼é–‹å§‹
            loadQuestion();


        }

        // --- ã‚¯ã‚¤ã‚ºãƒ­ã‚¸ãƒƒã‚¯ ---
        function loadQuestion() {
            const quizContainer = document.getElementById('quiz-container');
            const resultsContainer = document.getElementById('results-container');
            const feedbackEl = document.getElementById('feedback');
            const nextBtn = document.getElementById('next-btn');
            const resultsBtn = document.getElementById('results-btn');
            const optionsContainer = document.getElementById('options-container');
            const showOptionsBtn = document.getElementById('show-options-btn');
            const questionNumberEl = document.getElementById('question-number');
            const questionTextEl = document.getElementById('question-text');

            if (currentQuestionIndex >= quizData.length) return;

            // ãƒªã‚»ãƒƒãƒˆ
            feedbackEl.style.display = 'none';
            nextBtn.style.display = 'none';
            resultsBtn.style.display = 'none';
            document.getElementById('answer-btn').style.display = 'block';
            document.getElementById('analyzing-indicator').style.display = 'none';

            // ãƒ¡ãƒ¢ã¯æ¶ˆã•ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰ã®è¨ˆç®—ã‚’æ®‹ã—ãŸã„ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ï¼‰
            clearMemo();

            // ãƒ¡ãƒ¢ã®ã€Œå•é¡Œã‚’è¡¨ç¤ºã€ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('memo-question-overlay').style.display = 'none';
            document.getElementById('btn-toggle-question').classList.remove('active');

            updateProgressAndScore();
            saveProgress(); // é€²è¡ŒçŠ¶æ³ã‚’ä¿å­˜

            const currentQuestion = quizData[currentQuestionIndex];
            questionNumberEl.textContent = `å•é¡Œ ${currentQuestionIndex + 1} / ${quizData.length}`;
            questionTextEl.innerHTML = currentQuestion.question;

            // ãƒ¡ãƒ¢ãƒ‘ãƒƒãƒ‰ä¸Šã®å•é¡Œæ–‡æ›´æ–°
            document.getElementById('memo-question-overlay').innerHTML = `<strong>å•é¡Œ ${currentQuestionIndex + 1}:</strong><br>${currentQuestion.question}`;

            renderAllMath();
        }


        // --- ä¸æ­£è§£æ™‚ã®åˆ†å²ï¼ˆã‚‚ã†ä¸€åº¦è§£ãï¼æ­£è§£ã‚’æ•™ãˆã¦ï¼‰ ---
        let pendingAIResult = null; // { questionIndex, recognizedAnswer, feedback }

        // --- åŠ±ã¾ã—ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæ°—æŒã¡ã‚ˆã•UPï¼‰ ---
        const ENCOURAGEMENTS = [
            "OKï¼ä»Šã®æ°—ã¥ãã‚’æ´»ã‹ã—ã¦ã‚‚ã†ä¸€åº¦ã„ã“ã†ã€‚",
            "ãƒŠã‚¤ã‚¹åˆ¤æ–­ã€‚ã“ã“ã§ã‚„ã‚Šç›´ã›ã‚‹ã®ãŒå¼·ã„ã€‚",
            "å¤§ä¸ˆå¤«ã€‚1å›ç›®ã§æ°—ã¥ã‘ãŸã®ãŒåç©«ï¼",
            "è½ã¡ç€ã„ã¦ã„ã‘ã°å¿…ãšå–ã‚Œã‚‹ã€‚",
            "ä»Šã®ãƒŸã‚¹ã¯ä¼¸ã³ã—ã‚ã€‚æ¬¡ã§å›åã—ã‚ˆã†ã€‚",
            "ã„ã„ã­ã€‚ã“ã“ã‹ã‚‰ãŒæœ¬ç•ªã€‚",
            "æ›¸ãç›´ã—ã¦ã¿ã‚ˆã†ã€‚ç­”ãˆã«è¿‘ã¥ã„ã¦ã‚‹ã‚ˆã€‚"
        ];

        function showEncouragement() {
            const el = document.getElementById("encouragement-under-question");
            if (!el) return;
            const msg = ENCOURAGEMENTS[Math.floor(Math.random() * ENCOURAGEMENTS.length)];
            el.textContent = msg;
            el.style.display = "block";
        }

        function hideEncouragement() {
            const el = document.getElementById("encouragement-under-question");
            if (!el) return;
            el.style.display = "none";
            el.textContent = "";
        }

        function showWrongDecisionUI(currentQuestion, result) {
            const feedbackEl = document.getElementById('feedback');
            const nextBtn = document.getElementById('next-btn');
            const resultsBtn = document.getElementById('results-btn');
            const answerBtn = document.getElementById('answer-btn');

            nextBtn.style.display = 'none';
            resultsBtn.style.display = 'none';
            answerBtn.style.display = 'none';

            pendingAIResult = {
                questionIndex: currentQuestionIndex,
                recognizedAnswer: result.recognizedAnswer || '',
                feedback: result.feedback || ''
            };

            feedbackEl.className = 'incorrect-feedback';
            feedbackEl.innerHTML = `
                <div class="ai-banner">ğŸ¤–AIã‚«ã‚¬ãƒ¯å…ˆç”ŸğŸ¤–ã®è§£ç­”checkâœ…</div><br>
                <span style="color: var(--incorrect-color);"><strong>ä»Šå›ã¯ä¸æ­£è§£ã§ã—ãŸã€‚</strong></span><br>
                ã‚ãªãŸã®è§£ç­”: ${pendingAIResult.recognizedAnswer || '(èª­ã¿å–ã‚Šä¸å¯)'}<br>
                <div class="wrong-decision-area">
                    <button class="tool-btn ai-btn wrong-decision-btn" onclick="retryCurrentQuestion()">ğŸ” ã‚‚ã†ä¸€åº¦è§£ã</button>
                    <button class="tool-btn ai-btn wrong-decision-btn" onclick="revealCorrectWithAI()">âœ… æ­£è§£ã‚’æ•™ãˆã¦ï¼AIã‚«ã‚¬ãƒ¯å…ˆç”Ÿ</button>
                </div>
                <div class="wrong-decision-note">â€»ã€Œã‚‚ã†ä¸€åº¦è§£ãã€ã‚’é¸ã¶ã¨ï¼Œãƒ¡ãƒ¢ã‚’æ¶ˆã—ã¦è§£ãç›´ã›ã¾ã™ã€‚</div>
            `;
            feedbackEl.style.display = 'block';
            renderAllMath();
        }

        function retryCurrentQuestion() {
            pendingAIResult = null;

            clearMemo();

            const feedbackEl = document.getElementById('feedback');
            const answerBtn = document.getElementById('answer-btn');
            const indicator = document.getElementById('analyzing-indicator');
            const nextBtn = document.getElementById('next-btn');
            const resultsBtn = document.getElementById('results-btn');

            feedbackEl.style.display = 'none';
            indicator.style.display = 'none';
            nextBtn.style.display = 'none';
            resultsBtn.style.display = 'none';

            answerBtn.textContent = "ğŸ¤–AIã‚«ã‚¬ãƒ¯å…ˆç”ŸğŸ¤–ã«æ·»å‰Šã—ã¦ã‚‚ã‚‰ã†";
            answerBtn.style.display = 'block';

            showEncouragement();
        }

        function revealCorrectWithAI() {
            if (!pendingAIResult) return;

            const feedbackEl = document.getElementById('feedback');
            const nextBtn = document.getElementById('next-btn');
            const resultsBtn = document.getElementById('results-btn');

            const q = quizData[pendingAIResult.questionIndex] || quizData[currentQuestionIndex];

            if (!incorrectQuestions.includes(q)) {
                incorrectQuestions.push(q);
            }

            let html = `
                <div class="ai-banner">ğŸ¤–AIã‚«ã‚¬ãƒ¯å…ˆç”ŸğŸ¤–ã®è§£ç­”checkâœ…</div><br>
                <span style="color: var(--incorrect-color);"><strong>ä»Šå›ã¯ä¸æ­£è§£ã§ã—ãŸã€‚</strong></span><br>
                ã‚ãªãŸã®è§£ç­”: ${pendingAIResult.recognizedAnswer || '(èª­ã¿å–ã‚Šä¸å¯)'}<br>
                <strong>æ­£è§£: ${q.answer}</strong><br><br>
            `;

            if (pendingAIResult.feedback) {
                html += `${pendingAIResult.feedback}<br>`;
            }

            html += `<hr><div class="explanation-banner">è§£èª¬</div><br>${q.rationale || ""}`;

            feedbackEl.className = 'incorrect-feedback';
            feedbackEl.innerHTML = html;
            feedbackEl.style.display = 'block';
            renderAllMath();

            if (pendingAIResult.questionIndex < quizData.length - 1) {
                nextBtn.style.display = 'block';
                resultsBtn.style.display = 'none';
            } else {
                nextBtn.style.display = 'none';
                resultsBtn.style.display = 'block';
            }

            pendingAIResult = null;

            saveProgress();
            updateProgressAndScore();
        }

        // --- ã‚­ãƒ£ãƒ³ãƒã‚¹ç”»åƒå–å¾—ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ (AIãŠåŠ©ã‘ç”¨: ç™½èƒŒæ™¯ãƒ»é»’æ–‡å­—ãƒ»ã‚¯ãƒ­ãƒƒãƒ”ãƒ³ã‚°) ---
        function getCanvasImageBase64(scale = 1) {
            const originalCanvas = document.getElementById('memo-pad');
            const width = originalCanvas.width;
            const height = originalCanvas.height;
            const ctx = originalCanvas.getContext('2d');

            // 1. å…ƒã®ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;

            let minX = width, minY = height, maxX = 0, maxY = 0;
            let hasPixels = false;

            // 2. ãƒ”ã‚¯ã‚»ãƒ«æ“ä½œ & ãƒã‚¦ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒœãƒƒã‚¯ã‚¹æ¤œå‡º
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const i = (y * width + x) * 4;
                    const alpha = data[i + 3];

                    if (alpha > 50) { // æç”»ã‚ã‚Š
                        data[i] = 0;     // R -> é»’
                        data[i + 1] = 0; // G -> é»’
                        data[i + 2] = 0; // B -> é»’
                        data[i + 3] = 255; // å®Œå…¨ä¸é€æ˜

                        if (x < minX) minX = x;
                        if (x > maxX) maxX = x;
                        if (y < minY) minY = y;
                        if (y > maxY) maxY = y;
                        hasPixels = true;
                    } else {
                        data[i + 3] = 0; // é€æ˜
                    }
                }
            }

            if (!hasPixels) {
                // ç™½ç´™ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™ï¼ˆå¾Œç¶šã®åˆ¤å®šã§å¼¾ã‹ã‚Œã‚‹ã¯ãšï¼‰
                return originalCanvas.toDataURL('image/png').split(',')[1];
            }

            // 3. ä½œæ¥­ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œã‚‹ï¼ˆé»’æ–‡å­—ã®ã¿ï¼‰
            const workCanvas = document.createElement('canvas');
            workCanvas.width = width;
            workCanvas.height = height;
            const workCtx = workCanvas.getContext('2d');
            workCtx.putImageData(imageData, 0, 0);

            // 4. åˆ‡ã‚ŠæŠœãç¯„å›²ã®è¨ˆç®—ï¼ˆãƒ‘ãƒ‡ã‚£ãƒ³ã‚°è¿½åŠ ï¼‰
            const padding = 20;
            const cropX = Math.max(0, minX - padding);
            const cropY = Math.max(0, minY - padding);
            const cropWidth = Math.min(width, maxX + padding) - cropX;
            const cropHeight = Math.min(height, maxY + padding) - cropY;

            // 5. æå‡ºç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œã‚‹ï¼ˆåˆ‡ã‚ŠæŠœã„ãŸã‚µã‚¤ã‚ºï¼‰
            const exportCanvas = document.createElement('canvas');
            exportCanvas.width = cropWidth * scale;
            exportCanvas.height = cropHeight * scale;
            const exportCtx = exportCanvas.getContext('2d');

            // èƒŒæ™¯ã‚’ç™½ã§å¡—ã‚Šã¤ã¶ã™
            exportCtx.fillStyle = '#FFFFFF';
            exportCtx.fillRect(0, 0, exportCanvas.width, exportCanvas.height);

            // åˆ‡ã‚ŠæŠœã„ã¦æç”»
            exportCtx.drawImage(
                workCanvas,
                cropX, cropY, cropWidth, cropHeight, // å…ƒç”»åƒã®ç¯„å›²
                0, 0, exportCanvas.width, exportCanvas.height // å‡ºåŠ›å…ˆã®ç¯„å›²
            );

            return exportCanvas.toDataURL('image/png').split(',')[1];
        }

        async function checkAnswerWithAI() {
            const answerBtn = document.getElementById('answer-btn');
            const indicator = document.getElementById('analyzing-indicator');
            const feedbackEl = document.getElementById('feedback');
            const nextBtn = document.getElementById('next-btn');
            const resultsBtn = document.getElementById('results-btn');

            hideEncouragement();
            pendingAIResult = null;

            answerBtn.style.display = 'none';
            indicator.style.display = 'block';

            // iOSå¯¾ç­–: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ç›´å¾Œã«AudioContextã‚’å†é–‹ã™ã‚‹
            if (isSoundOn && audioCtx) {
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
            } else if (isSoundOn && !audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    audioCtx = new AudioContext();
                    audioCtx.resume();
                }
            }

            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                alert("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚");
                indicator.style.display = 'none';
                answerBtn.style.display = 'block';
                return;
            }
            // --- é€‹ï½½é‚å¶ãƒ¡ç¹§ï½§ç¹ãƒ»ã‘ ---
            const memoPad = document.getElementById('memo-pad');
            if (typeof isCanvasBlank === 'function' && isCanvasBlank(memoPad)) {
                indicator.style.display = 'none';
                playSound('incorrect');

                const feedbackEl = document.getElementById('feedback');

                feedbackEl.className = 'incorrect-feedback';
                feedbackEl.innerHTML = `
                    <div class="ai-banner">ğŸ¤–AIã‚«ã‚¬ãƒ¯å…ˆç”ŸğŸ¤–ã®è§£ç­”checkâœ…</div><br>
                    <span style="color: var(--incorrect-color);"><strong>ãƒ¡ãƒ¢ãŒç™½ç´™ã®ã‚ˆã†ã§ã™ğŸ’¦</strong></span><br>
                    ãƒ¡ãƒ¢å¸³ã«è¨˜è¿°ãŒãªã„å ´åˆã¯åˆ†æãŒã§ããªã„ã®ã§ï¼Œè§£ç­”ã¯ãƒ¡ãƒ¢å¸³ã«æ›¸ã„ã¦ãã ã•ã„ã­ï¼<br>
                    <div class="wrong-decision-area">
                        <button class="tool-btn ai-btn wrong-decision-btn" onclick="retryCurrentQuestion()">ğŸ” ã‚‚ã†ä¸€åº¦è§£ã</button>
                    </div>
                `;
                feedbackEl.style.display = 'block';
                return;
            }


            const currentQuestion = quizData[currentQuestionIndex];

            try {
                // html2canvaså»ƒæ­¢ -> ç›´æ¥ã‚­ãƒ£ãƒ³ãƒã‚¹ã‹ã‚‰ç”»åƒã‚’ç”Ÿæˆ
                const imageData = getCanvasImageBase64(1);

                const prompt = `
ã‚ãªãŸã¯é«˜æ ¡æ•°å­¦ã®ã€Œèª¤ã‚Šè¨ºæ–­ã€ã«ç‰¹åŒ–ã—ãŸæ·»å‰Šè€…ã§ã™ã€‚
ä»¥ä¸‹ã®å•é¡Œã«å¯¾ã™ã‚‹ç”Ÿå¾’ã®æ‰‹æ›¸ãè§£ç­”ï¼ˆç”»åƒï¼‰ã‚’èª­ã¿å–ã‚Šï¼Œ
æœ€çµ‚ç­”æ¡ˆã®æ­£èª¤ã¨ï¼Œé€”ä¸­å¼ã®æ•°å­¦çš„æ•´åˆæ€§ã ã‘ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦ç¢ºèªäº‹é …ã€‘
- ç”»åƒã¯æ‰‹æ›¸ãã®æ–‡å­—ã§ã™ã€‚ç‰¹ã«**æ•°å­—ã®ã€Œ0ã€ã‚„ã€Œ6ã€ã€Œ8ã€ã€Œ9ã€ãªã©ã®é–‰ã˜ãŸæ•°å­—**ã‚’æ³¨æ„æ·±ãèª­ã¿å–ã£ã¦ãã ã•ã„ã€‚
- å°‘ã—ç·šãŒé›¢ã‚Œã¦ã„ãŸã‚Šã€ã‹ã™ã‚Œã¦ã„ã¦ã‚‚ã€æ•°å­¦çš„ãªæ–‡è„ˆã‹ã‚‰æ•°å­—ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚
- å°ã•ãªä¸¸ã‚„ç‚¹ã‚‚ã€Œ0ã€ã‚„ã€Œå°æ•°ç‚¹ã€ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

å•é¡Œ: ${currentQuestion.question}
æ­£è§£: ${currentQuestion.answer}
è§£èª¬(å‚è€ƒ): ${currentQuestion.rationale}

ã€æ¡ç‚¹è€…ã¨ã—ã¦ã®å‰æã€‘
- ã‚ãªãŸã¯ã€Œå³å¯†ã•ã‚’é‡è¦–ã™ã‚‹é«˜æ ¡æ•°å­¦æ•™å¸«ã€ã§ã™ã€‚
- ç”Ÿå¾’ã‚’è²¬ã‚ã‚‹ã®ã§ã¯ãªãï¼ŒçŸ­ãã‚„ã•ã—ã„ã‚³ãƒ¡ãƒ³ãƒˆã§èª¤ã‚Šã®ç¨®é¡ã‚„åŸå› ã‚’ä¼ãˆã¾ã™ãŒï¼Œ
  æ­£èª¤ã‚„é€”ä¸­å¼ã®åˆ¤å®šãã®ã‚‚ã®ã¯ç”˜ãã—ã¦ã¯ã„ã‘ã¾ã›ã‚“ã€‚

ã€é€”ä¸­å¼ãƒã‚§ãƒƒã‚¯ã®æ–¹é‡ï¼ˆå¿…ãšå®Ÿè¡Œã™ã‚‹å†…éƒ¨æ‰‹é †ã€‚å‡ºåŠ›ã«ã¯æ›¸ã‹ãªã„ï¼‰ã€‘
- ã¾ãšï¼Œä¸ãˆã‚‰ã‚ŒãŸã€Œæ­£è§£ã€ã¨ã€Œè§£èª¬(å‚è€ƒ)ã€ã‚’æ‰‹ãŒã‹ã‚Šã«ï¼Œ
  ãã®å•é¡Œã®å…¸å‹çš„ãªæ¨¡ç¯„è§£ç­”ã®æµã‚Œã‚’ 3ã€œ6 å€‹ç¨‹åº¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã«
  é ­ã®ä¸­ã§æ•´ç†ã—ãªã•ã„ï¼ˆã“ã®å†…å®¹ã¯å‡ºåŠ›ã—ãªã„ï¼‰ã€‚
- æ¬¡ã«ï¼Œç”Ÿå¾’ã®è§£ç­”ã‚’ä¸Šã‹ã‚‰é †ã«èª­ã¿ï¼Œ
  è¡Œã‚„ã¾ã¨ã¾ã‚Šã”ã¨ã«ã€Œã‚¹ãƒ†ãƒƒãƒ—ã€ã¨ã¿ãªã—ã¦ï¼Œå‰å¾Œã®ã¤ãªãŒã‚Šã‚’ç¢ºèªã—ãªã•ã„ã€‚
- ç”Ÿå¾’ã®å„ã‚¹ãƒ†ãƒƒãƒ—ãŒï¼Œã€Œè§£èª¬(å‚è€ƒ)ã€ã®ã©ã®ã‚¹ãƒ†ãƒƒãƒ—ã«å¯¾å¿œã—ã¦ã„ã‚‹ã‹ã‚’å¤§ã¾ã‹ã«å¯¾å¿œã¥ã‘ï¼Œ
  ã©ã®æ®µéšã§ã‚ºãƒ¬ãƒ»çœç•¥ãƒ»èª¤ã‚ŠãŒç”Ÿã˜ã¦ã„ã‚‹ã‹ã‚’æŠŠæ¡ã—ãªã•ã„ã€‚
- å„ã‚¹ãƒ†ãƒƒãƒ—ã«ã¤ã„ã¦ï¼Œå¿…ãšæ¬¡ã® 3 ç‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã—ãªã•ã„ï¼š
  1. æ•°å­¦çš„ã«æ­£ã—ã„å¼å¤‰å½¢ãƒ»è«–ç†ã«ãªã£ã¦ã„ã‚‹ã‹ã€‚
  2. ç›´å‰ã®ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰è«–ç†çš„ã«å°ã‹ã‚Œã¦ã„ã‚‹ã‹ï¼ˆé£›èºãŒãªã„ã‹ï¼‰ã€‚
  3. ç­‰å¼ãƒ»ä¸ç­‰å¼ã®å ´åˆï¼ŒåŒå€¤å¤‰å½¢ã«ãªã£ã¦ã„ã‚‹ã‹ã€‚
- è§£èª¬ã¨ã¯åˆ¥è§£ã§ã‚ã£ã¦ã‚‚ï¼Œæ•°å­¦çš„ã«æ­£ã—ãï¼Œæ¡ä»¶ã‚’ãã¡ã‚“ã¨ä½¿ã£ã¦ã„ã‚Œã°å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
  ãŸã ã—ï¼Œæ¡ä»¶æŠœã‘ã‚„è«–ç†ã®é£›èºãŒã‚ã‚Œã°èª¤ã‚Šã¨ã—ã¦æ‰±ã„ãªã•ã„ã€‚
- é€”ä¸­ã« 1 ç®‡æ‰€ã§ã‚‚ï¼Œæ¬¡ã®ã‚ˆã†ãªã‚‚ã®ãŒã‚ã‚Œã°ï¼Œ
  æœ€çµ‚ç­”æ¡ˆãŒæ­£ã—ãã¦ã‚‚ hasProcessError ã‚’ true ã¨ã—ãªã•ã„ï¼š
  - æ˜ã‚‰ã‹ãªè¨ˆç®—ãƒŸã‚¹ã‚„å¤‰å½¢ãƒŸã‚¹
  - åŒå€¤ã§ãªã„å¼å¤‰å½¢
  - æ¡ä»¶ã®è¦‹è½ã¨ã—ã‚„è«–ç†ã®é£›èº
  - çŸ›ç›¾ã—ãŸè¨˜è¿°
- èª¤ã£ãŸå¼ã‚„å‰æã‹ã‚‰å‡ºç™ºã—ã¦ã„ã‚‹ã®ã«ï¼Œ
  ãã®å¾Œã®è¨ˆç®—ã«ã‚ˆã‚ŠãŸã¾ãŸã¾æ­£ã—ã„æœ€çµ‚çµæœã«åˆ°é”ã—ã¦ã„ã‚‹å ´åˆã¯ï¼Œ
  ã€Œé€”ä¸­ã«èª¤ã‚ŠãŒã‚ã‚‹ãŒçµæœãŒå¶ç„¶ä¸€è‡´ã—ã¦ã„ã‚‹çŠ¶æ…‹ã€ã¨ã¿ãªã—ï¼Œ
  isCorrect ã¯æœ€çµ‚ç­”æ¡ˆã§åˆ¤å®šã—ã¤ã¤ï¼Œå¿…ãš hasProcessError ã‚’ true ã¨ã—ï¼Œ
  feedback ã§ã¯ã€Œé€”ä¸­ã«èª¤ã‚ŠãŒã‚ã‚‹ã®ã«çµæœã ã‘åˆã£ã¦ã„ã‚‹ã€ã“ã¨ã‚’çŸ­ãæŒ‡æ‘˜ã—ãªã•ã„ã€‚

ã€è§£èª¬(å‚è€ƒ)ã®ä½¿ã„æ–¹ã€‘
- ã€Œè§£èª¬(å‚è€ƒ)ã€ã¯ãã®å•é¡Œã®æ­£ã—ã„è§£æ³•ã®ä¸€ä¾‹ã§ã™ã€‚
- é€”ä¸­å¼ãƒã‚§ãƒƒã‚¯ã§ã¯ï¼Œã“ã®è§£èª¬ã®æµã‚Œã‚’åŸºæº–ã«ã—ã¦ï¼Œ
  ç”Ÿå¾’ãŒã©ã®ã‚¹ãƒ†ãƒƒãƒ—ã§
  - è§£èª¬ã¨é•ã†è¨ˆç®—ã‚„å¤‰å½¢ã‚’ã—ã¦ã„ã‚‹ã‹
  - å¿…è¦ãªèª¬æ˜ã‚„å¤‰å½¢ã‚’çœç•¥ã—ã¦ã„ã‚‹ã‹
  - åˆ¥ã®æ–¹é‡ã‚’å–ã£ã¦ã„ã¦ï¼Œãã‚ŒãŒæ­£ã—ã„ã‹ã©ã†ã‹
  ã‚’æ¨æ¸¬ã—ãªã•ã„ã€‚
- feedbackã‚’æ›¸ãã¨ãã¯ï¼Œå¯èƒ½ã§ã‚ã‚Œã°
  ã€Œè§£èª¬ã®â—‹â—‹ã«ã‚ãŸã‚‹éƒ¨åˆ†ã§ã€œã‚’ã—ã¦ã„ãªã„ï¼åˆ¥ã®å¼ã‚’æ›¸ã„ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€
  ã®ã‚ˆã†ã«ï¼Œè§£èª¬ã¨ã®ã‚ºãƒ¬ã‚’æ„è­˜ã—ãŸä¸€è¨€ã‚’å«ã‚ãªã•ã„ï¼ˆãŸã ã—å­—æ•°ã¯å®ˆã‚‹ï¼‰ã€‚

ã€æœ€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
0. ã€æœ€é‡è¦ã€‘ç”»åƒã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰‹æ›¸ããŒå…¨ãè¦‹å½“ãŸã‚‰ãªã„ï¼ˆç™½ç´™ï¼‰å ´åˆã¯ã€çµ¶å¯¾ã«ã€Œä¸æ­£è§£ã€ã¨åˆ¤å®šã—ã€isCorrect: false ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚ã€Œå›ç­”ãŒè¦‹å½“ãŸã‚Šã¾ã›ã‚“ã€ã¨æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚
1. ç”»åƒã«ä½•ã‚‚æ›¸ã‹ã‚Œã¦ã„ãªã„ï¼Œã¾ãŸã¯ç™½ç´™ã«è¿‘ã„å ´åˆã¯å¿…ãšä¸æ­£è§£ã¨ã™ã‚‹ã€‚
2. ãã®å ´åˆã¯ä»¥ä¸‹ã®JSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦çµ‚äº†ã™ã‚‹ï¼š
   {"isCorrect": false, "hasProcessError": false, "recognizedAnswer": "", "feedback": "ãƒ¡ãƒ¢å¸³ã«è¨˜è¿°ãŒãªã„å ´åˆã¯åˆ†æãŒã§ããªã„ã®ã§ï¼Œè§£ç­”ã¯ãƒ¡ãƒ¢å¸³ã«æ›¸ã„ã¦ãã ã•ã„ã­ï¼"}
3. æœ€çµ‚ç­”æ¡ˆãŒæ­£è§£ã¨ä¸€è‡´ã—ã¦ã„ã‚‹å ´åˆã®ã¿ isCorrect ã‚’ true ã¨ã™ã‚‹ã€‚
   - æœ‰ç†åŒ–ã§åŒã˜ï¼ŒåŒå€¤å¤‰å½¢ï¼Œç©ã®é †åºé•ã„ãªã©ã¯æ­£è§£æ‰±ã„ã€‚
   - é€”ä¸­å¼ã«èª¤ã‚ŠãŒã‚ã‚‹ã‹ã©ã†ã‹ã¯ isCorrect ã§ã¯ãªã hasProcessError ã§åˆ¤å®šã—ï¼Œ
     èª¤ã‚ŠãŒã‚ã‚Œã°å¿…ãš hasProcessError ã‚’ true ã«ã™ã‚‹ã“ã¨ã€‚
4. é€”ä¸­å¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ï¼Œå¿…ãšå…¨ã¦ã®é€”ä¸­å¼ã®æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚
   - 1 è¡Œã”ã¨ï¼Œã¾ãŸã¯æ„å‘³ã®ã¾ã¨ã¾ã‚Šã”ã¨ã«ï¼Œã€Œå‰ã®è¡Œã¨è«–ç†çš„ã«ã¤ãªãŒã£ã¦ã„ã‚‹ã‹ã€
     ã€Œå·¦è¾ºã¨å³è¾ºãŒæœ¬å½“ã«ç­‰ã—ã„ã‹ï¼åŒå€¤ã‹ã€ã‚’ç¢ºèªã™ã‚‹ã€‚
5. æœ€çµ‚ç­”æ¡ˆãŒæ­£è§£ã§ã‚‚é€”ä¸­å¼ã«æ•°å­¦çš„ãªèª¤ã‚Šã‚„é£›èºãŒã‚ã‚‹å ´åˆï¼Œ
   hasProcessError ã‚’ true ã¨ã—ï¼Œ
   feedback ã§çŸ­ãæŒ‡æ‘˜ã™ã‚‹ã€‚
   - é€”ä¸­ã«èª¤ã£ãŸå¼ã‚„ä¸æ­£ç¢ºãªåŒå€¤å¤‰å½¢ãŒ 1 å›ã§ã‚‚ã‚ã‚Œã°ï¼Œ
     ã€Œç´°ã‹ã„ã‹ã‚‰ã„ã„ã‹ã€ã¨è¦‹é€ƒã•ãšã« hasProcessError ã‚’ true ã«ã™ã‚‹ã€‚
6. é€”ä¸­å¼ãŒã»ã¼ç„¡ã„ï¼Œã¾ãŸã¯æ–‡å­—ãŒã¤ã¶ã‚Œã¦èª­ã‚ãªã„å ´åˆã¯ï¼Œ
   hasProcessError ã‚’ false ã«ã—ã¦ã‚ˆã„ãŒï¼Œ
   feedback ã«ã€Œé€”ä¸­å¼ãŒèª­ã¿å–ã‚Œãªã„ãŸã‚éç¨‹ã®æ¤œè¨¼ã¯ä¸ååˆ†ã€ã¨çŸ­ãæ›¸ãã€‚
7. é–“é•ã„ã®è¦å› ã¨ã—ã¦ã€Œè¨ˆç®—ãƒŸã‚¹ã€ã ã‘ã§ãªã
   ã€Œæ•°å¼ã®å†™ã—é–“é•ã„ï¼ˆå•é¡Œæ–‡ã®å¼ã‚„æ¡ä»¶ã®è»¢è¨˜ãƒŸã‚¹ï¼‰ã€ã‚‚é‡è¦ãªèª¤ã‚Šã¨ã—ã¦æ‰±ã†ã€‚
   - ç‰¹ã«ï¼Œå•é¡Œæ–‡ã®å¼ã‚„æ¡ä»¶ã‚’æ›¸ãå†™ã—ã¦ã„ã‚‹æœ€åˆã®æ•°è¡Œã«ã¤ã„ã¦ã¯ï¼Œ
     ç¬¦å·ãƒ»ä¿‚æ•°ãƒ»æŒ‡æ•°ãƒ»ä¸ç­‰å·ã®å‘ããªã©ã®é•ã„ãŒãªã„ã‹ã‚’å„ªå…ˆçš„ã«ãƒã‚§ãƒƒã‚¯ã—ï¼Œ
     èª¤ã‚ŠãŒã‚ã‚Œã°ã€Œå†™ã—é–“é•ã„ã€ã¨ã—ã¦æŒ‡æ‘˜ã™ã‚‹ã€‚
8. æ­£èª¤åˆ¤å®šå•é¡Œï¼ˆç­”ãˆãŒã€Œæ­£ã—ã„ã€ã€Œæ­£ã—ããªã„ã€ã®å ´åˆï¼‰ã«ã¤ã„ã¦:
   - æ¼¢å­—ã®å´©ã‚Œã‚„ã²ã‚‰ãŒãªè¡¨è¨˜ï¼ˆä¾‹ï¼šã€ŒãŸã ã—ã„ã€ï¼‰ã§ã‚‚æ„å›³ãŒæ˜ç¢ºãªã‚‰æ¡ç‚¹ã™ã‚‹ã€‚
   - ã€Œã€‡ã€ã€ŒÃ—ã€ã¯ãã‚Œãã‚Œã€Œæ­£ã—ã„ã€ã€Œæ­£ã—ããªã„ã€ã«å¯¾å¿œã•ã›ã¦æ¡ç‚¹ã™ã‚‹ã€‚
9. æ•°å¼ã¯å¿…ãšLaTeXå½¢å¼ï¼ˆ$...$ï¼‰ã§è¨˜è¿°ã™ã‚‹ã€‚åˆ†æ•°ã¯ \\\\frac{a}{b} ã‚’ç”¨ã„ã‚‹ã€‚
   é›†åˆè¨˜å·ï¼ˆ\\\\subset,\\\\subseteq,\\\\supset,\\\\supseteq,\\\\in,\\\\notin,\\\\cup,\\\\cap,\\\\emptyset ãªã©ï¼‰ã‚‚
   å¿…ãš $...$ ã®ä¸­ã«å…¥ã‚Œã‚‹ã€‚
   ä¾‹ï¼šã€ŒAã¯Bã®éƒ¨åˆ†é›†åˆãªã®ã§ $A \\\\subset B$ã€ã€‚
10. JSONå‡ºåŠ›æ™‚ã€æ–‡å­—åˆ—å†…ã®ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã¯å¿…ãšã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ã€Œ\\\\ã€ã¨è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
    ï¼ˆä¾‹ï¼šã€Œ\\\\{ã€ã§ã¯ãªãã€Œ\\\\\\\\{ã€ï¼‰

ã€èƒŒç†æ³•ãªã©ã®è¨¼æ˜å•é¡Œã«é–¢ã™ã‚‹è¿½åŠ ãƒ«ãƒ¼ãƒ«ã€‘
- è§£ç­”ãŒèƒŒç†æ³•ã‚’ç”¨ã„ã¦ã„ã‚‹å ´åˆã¯ï¼Œæ¬¡ã® 4 ç‚¹ã‚’å¿…ãšç¢ºèªã—ãªã•ã„ã€‚
  1. è¨¼æ˜ã—ãŸã„å‘½é¡Œã®ã€Œå¦å®šã€ã‚’ï¼Œã¯ã£ãã‚Šä»®å®šã—ã¦ã„ã‚‹ã‹ã€‚
  2. ãã®ä»®å®šã®ã‚‚ã¨ã§ï¼Œæ­£ã—ã„å¼å¤‰å½¢ãƒ»è«–ç†å±•é–‹ã‚’è¡Œã£ã¦ã„ã‚‹ã‹ã€‚
  3. ä»®å®šã¨çŸ›ç›¾ã™ã‚‹å†…å®¹ï¼ˆå¤§å°é–¢ä¿‚ã®çŸ›ç›¾ï¼Œå¶å¥‡ã‚„æ•´æ•°æ€§ã®çŸ›ç›¾ãªã©ï¼‰ã‚’æ˜ç¢ºã«å°ã„ã¦ã„ã‚‹ã‹ã€‚
  4. ã€Œä»®å®šãŒèª¤ã‚Š â†’ å…ƒã®å‘½é¡ŒãŒæˆã‚Šç«‹ã¤ã€ã¨ã„ã†çµè«–ã‚’ï¼Œæœ€å¾Œã«æ˜ç¤ºã—ã¦ã„ã‚‹ã‹ã€‚
- ä¸Šã®ã„ãšã‚Œã‹ãŒæ¬ ã‘ã¦ã„ã‚‹å ´åˆã¯ï¼Œæœ€çµ‚çš„ãªçµè«–ã®æ–‡è¨€ãŒæ­£ã—ãã¦ã‚‚ï¼Œ
  hasProcessError ã‚’ true ã¨ã—ï¼Œè«–è¨¼ã¨ã—ã¦ä¸ååˆ†ã§ã‚ã‚‹ã“ã¨ã‚’ feedback ã§çŸ­ãæŒ‡æ‘˜ã—ãªã•ã„ã€‚

ã€feedbackã®æ›¸ãæ–¹ï¼ˆã‚„ã•ã—ããƒ»åŸå› ã‚‚æ„è­˜ã—ã¦çŸ­ãï¼‰ã€‘
- 50ã€œ120å­—ç¨‹åº¦ã€‚
- æŒ‡æ‘˜ã¯æœ€å¤§2ç‚¹ã¾ã§ã€‚
- è§£èª¬ã‚„æ¨¡ç¯„è§£ç­”ã®å†æç¤ºã¯ç¦æ­¢ï¼ˆè§£èª¬ã¯åˆ¥ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰ã€‚
- ã§ãã‚‹é™ã‚Šï¼Œæ¬¡ã®2ã¤ã‚’ã‚»ãƒƒãƒˆã§ç°¡æ½”ã«æ›¸ããªã•ã„ï¼š
  1. ã©ã®è¡Œãƒ»ã©ã®å¼ã§ã©ã‚“ãªèª¤ã‚ŠãŒã‚ã£ãŸã‹ï¼ˆè¡¨é¢çš„ãªèª¤ã‚Šï¼‰
  2. ãã®èƒŒæ™¯ã«ã‚ã‚Šãã†ãªåŸå› ã®æ¨æ¸¬ï¼ˆã€œã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ï¼Œã‚‚ã—ã‹ã—ã¦ã€œãªã©ï¼‰
- èª¤ã‚Šã‚¿ã‚¤ãƒ—ã®ä¾‹ï¼š
  è¨ˆç®—ãƒŸã‚¹ï¼ç¬¦å·ãƒŸã‚¹ï¼å…¬å¼ã®é©ç”¨æ¡ä»¶ãƒŸã‚¹ï¼åŒå€¤å¤‰å½¢ã®èª¤ã‚Šï¼è«–ç†ã®é£›èºï¼å†™ã—é–“é•ã„
- åŸå› ãŒç¢ºå®Ÿã«ç‰¹å®šã§ãã‚‹å ´åˆã¯æ–­å®šã—ã¦ã‚ˆã„ãŒï¼Œ
  å®Œå…¨ã«ã¯ç‰¹å®šã§ããªã„å ´åˆã¯ï¼Œ
  ã€Œã€œã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€ã€Œã€œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€ã€Œã‚‚ã—ã‹ã—ã¦ã€œã—ã¦ã—ã¾ã£ãŸã‹ãªï¼Ÿã€ãªã©ï¼Œ
  æ¨æ¸¬ã§ã‚ã‚‹ã“ã¨ãŒåˆ†ã‹ã‚‹ã‚„ã‚ã‚‰ã‹ã„è¡¨ç¾ã‚’ç”¨ã„ãªã•ã„ã€‚
  ä¾‹ï¼š
  - ã€Œ2è¡Œç›®ã§ $-3$ ã‚’ $+3$ ã¨ã—ã¦ã„ã‚‹ã®ã§ç¬¦å·ãƒŸã‚¹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã€
  - ã€Œè§£èª¬ã§ä½¿ã£ã¦ã„ã‚‹å…¬å¼ã®å½¢ã‚’ã†ã‚è¦šãˆã§é©ç”¨ã—ã¦ã—ã¾ã£ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã€
- ä¸æ­£è§£ã®å ´åˆã¯ï¼Œæœ€ã‚‚è‡´å‘½çš„ãªèª¤ã‚Šç®‡æ‰€ã‚’å„ªå…ˆã—ã¦æŒ‡æ‘˜ã—ï¼Œ
  å¯èƒ½ã§ã‚ã‚Œã°ã€Œãªãœãã†æ›¸ã„ã¦ã—ã¾ã£ãŸã‹ã€ã®æ¨æ¸¬ã‚‚ä¸€è¨€ããˆã‚‹ã€‚
- æ­£è§£ã ãŒ hasProcessError ãŒ true ã®å ´åˆã¯
  ã€Œç­”ãˆã¯åˆã£ã¦ã„ã¾ã™ãŒï¼Œé€”ä¸­å¼ã«èª¤ã‚ŠãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚ã€ã®ã‚ˆã†ã«ï¼Œ
  ç­”ãˆã¯èªã‚ã¤ã¤éç¨‹ã®å•é¡Œã¨ãã®åŸå› ã®æ¨æ¸¬ã‚’çŸ­ãæŒ‡æ‘˜ã™ã‚‹ã€‚
- æ­£è§£ã‹ã¤é€”ä¸­å¼ã«ã‚‚å•é¡ŒãŒãªã„å ´åˆã®ã¿ï¼Œfeedback ã‚’ç©ºæ–‡å­—ã«ã™ã‚‹ã€‚

ã€å‡ºåŠ›ã€‘
ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚Markdownã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ä¸è¦ã§ã™ã€‚
{
  "isCorrect": true ã¾ãŸã¯ false,
  "hasProcessError": true ã¾ãŸã¯ false,
  "recognizedAnswer": "ç”»åƒã‹ã‚‰èª­ã¿å–ã£ãŸç”Ÿå¾’ã®æœ€çµ‚è§£ç­”ï¼ˆLaTeX $...$ï¼‰ã€‚èª­ã¿å–ã‚Œãªã„å ´åˆã¯ç©ºæ–‡å­—ã€‚",
  "feedback": "èª¤ã‚Šè¨ºæ–­ã‚³ãƒ¡ãƒ³ãƒˆã€‚æ­£è§£ã‹ã¤éç¨‹ã‚‚å•é¡Œãªã‘ã‚Œã°ç©ºæ–‡å­—ã€‚"
}
`;

                const response = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    {
                                        inline_data: {
                                            mime_type: "image/png",
                                            data: imageData
                                        }
                                    }
                                ]
                            }]
                        })
                    }
                );

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || "API Error");
                }

                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text
                    .replace(/```json/g, '')
                    .replace(/```/g, '')
                    .trim();

                const result = parseAIJsonWithRepair(aiText);

                if (result.recognizedAnswer === 'null' || result.recognizedAnswer === null) result.recognizedAnswer = '';
                if (result.feedback === 'null' || result.feedback === null) result.feedback = '';
                if (result.hasProcessError === 'null' || result.hasProcessError === null) result.hasProcessError = false;

                // ä¸æ­£è§£ãªã®ã«èª¤èª˜å°è¡¨ç¾ãŒæ··ã–ã£ãŸå ´åˆã®å®‰å…¨å¼
                const misleading = /(ç­”ãˆ|çµè«–)ã¯åˆã£ã¦(ã„|)ã¾ã™|å¶ç„¶æ­£è§£/;
                if (result.isCorrect === false && misleading.test(result.feedback || "")) {
                    result.feedback = "é€”ä¸­ã®è¨ˆç®—ã‚„æ¡ä»¶ã®ç¢ºèªãŒå¿…è¦ã§ã™ã€‚ã‚†ã£ãã‚Šè¦‹ç›´ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚";
                }

                indicator.style.display = 'none';

                if (result.isCorrect) {
                    score++;
                    playSound('correct');

                    // æ­£è§£æ¸ˆã¿ãªã‚‰ä¸æ­£è§£ãƒªã‚¹ãƒˆã‹ã‚‰å¤–ã™ï¼ˆä»»æ„ï¼‰
                    const idx = incorrectQuestions.indexOf(currentQuestion);
                    if (idx !== -1) incorrectQuestions.splice(idx, 1);

                    feedbackEl.className = 'correct-feedback';

                    const caution = result.hasProcessError
                        ? `<br><span style="color: var(--incorrect-color);"><strong>â€»ç­”ãˆã¯åˆã£ã¦ã„ã¾ã™ãŒï¼Œé€”ä¸­å¼ã«èª¤ã‚ŠãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚</strong></span><br>`
                        : `<br>`;

                    let feedbackHtml =
                        `<div class="ai-banner">ğŸ¤–AIã‚«ã‚¬ãƒ¯å…ˆç”ŸğŸ¤–ã®è§£ç­”checkâœ…</div><br>` +
                        `<span style="color: var(--correct-color);"><strong>æ­£è§£ï¼ğŸ’</strong></span>${caution}` +
                        `ã‚ãªãŸã®è§£ç­”: ${result.recognizedAnswer || '(èª­ã¿å–ã‚Šä¸å¯)'}<br>`;

                    if (result.feedback) {
                        feedbackHtml += `<br>${result.feedback}<br>`;
                    }

                    feedbackEl.innerHTML = feedbackHtml;

                    saveProgress();
                    updateProgressAndScore();

                    feedbackEl.innerHTML += `<hr><div class="explanation-banner">è§£èª¬</div><br>${currentQuestion.rationale || ""}`;
                    feedbackEl.style.display = 'block';
                    renderAllMath();

                    if (currentQuestionIndex < quizData.length - 1) {
                        nextBtn.style.display = 'block';
                    } else {
                        resultsBtn.style.display = 'block';
                    }

                } else {
                    playSound('incorrect');

                    // ä¸æ­£è§£æ™‚ã¯2æŠã‚’æç¤ºï¼ˆã“ã“ã§ã¯ã¾ã æ­£è§£ã‚‚è§£èª¬ã‚‚å‡ºã•ãªã„ï¼‰
                    showWrongDecisionUI(currentQuestion, result);

                    saveProgress();
                    updateProgressAndScore();
                }

            } catch (error) {
                console.error("Gemini API error:", error);
                const msg = String(error.message || '');

                if (
                    msg.includes('Quota exceeded') ||
                    msg.includes('rate limit') ||
                    msg.includes('429')
                ) {
                    alert(
                        "AIã®ç„¡æ–™åˆ©ç”¨å›æ•°ã®ä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚\\n" +
                        "å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
                    );
                } else {
                    alert("æ¡ç‚¹ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚\\nè©³ç´°: " + msg);
                }

                indicator.style.display = 'none';
                answerBtn.style.display = 'block';
            }
        }

        function selectAnswer(selectedAnswer, btnElement) {
            // iOSå¯¾ç­–: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã®ç›´å¾Œã«AudioContextã‚’å†é–‹ã™ã‚‹
            if (isSoundOn && audioCtx) {
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }
            } else if (isSoundOn && !audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    audioCtx = new AudioContext();
                    audioCtx.resume();
                }
            }

            const currentQuestion = quizData[currentQuestionIndex];
            const isCorrect = (selectedAnswer === currentQuestion.answer);
            const feedbackEl = document.getElementById('feedback');
            const nextBtn = document.getElementById('next-btn');
            const resultsBtn = document.getElementById('results-btn');

            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            document.getElementById('show-options-btn').style.display = 'none';

            if (isCorrect) {
                score++;
                playSound('correct');
                btnElement.classList.add('correct');
                feedbackEl.className = 'correct-feedback';
                feedbackEl.innerHTML = `<span style="color: var(--correct-color);"><strong>æ­£è§£ï¼ğŸ’</strong></span><br>`;
            } else {
                playSound('incorrect');
                btnElement.classList.add('incorrect', 'selected');
                feedbackEl.className = 'incorrect-feedback';
                feedbackEl.innerHTML = `<span style="color: var(--incorrect-color);"><strong>ä¸æ­£è§£ğŸ’¦</strong></span><br>ï¼ˆæ­£è§£: ${currentQuestion.answer}ï¼‰<br>`;
            }     // æ­£è§£ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            document.querySelectorAll('.option-btn').forEach(b => {
                if (b.dataset.optionValue === currentQuestion.answer) b.classList.add('correct');
            });

            // â˜… AIåˆ†æãƒœã‚¿ãƒ³ã‚’è¿½åŠ  (ä¸æ­£è§£æ™‚ã®ã¿)
            if (!isCorrect) {
                feedbackEl.innerHTML += `<button class="ai-btn" onclick="analyzeError()">ğŸ¤– AIã‚«ã‚¬ãƒ¯å…ˆç”Ÿã«èã (v2)</button><small> (ãƒ¡ãƒ¢ã‚’åˆ†æã—ã¾ã™)<small><br>`;

                // é–“é•ãˆãŸå•é¡Œã‚’è¨˜éŒ²
                if (!incorrectQuestions.includes(currentQuestion)) {
                    incorrectQuestions.push(currentQuestion);
                }
            }

            saveProgress(); // é€²è¡ŒçŠ¶æ³ã‚’ä¿å­˜

            updateProgressAndScore();

            // è§£èª¬è¿½åŠ 
            feedbackEl.innerHTML += currentQuestion.rationale || "";
            feedbackEl.style.display = 'block';
            renderAllMath();

            if (currentQuestionIndex < quizData.length - 1) {
                nextBtn.style.display = 'block';
            } else {
                resultsBtn.style.display = 'block';
            }
        }

        function updateProgressAndScore() {
            document.getElementById('score').textContent = `ã‚¹ã‚³ã‚¢: ${score} / ${quizData.length}`;
            const progress = (currentQuestionIndex + 1) / quizData.length * 100;
            document.getElementById('progress').style.width = `${progress}%`;
        }

        document.getElementById('next-btn').addEventListener('click', () => {
            currentQuestionIndex++;
            loadQuestion();
        });

        document.getElementById('results-btn').addEventListener('click', () => {
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('results-container').style.display = 'block';

            clearProgress(); // çµ‚äº†ã—ãŸã‚‰ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤

            const endTime = Date.now();
            const elapsedSeconds = Math.floor((endTime - startTime) / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            const timeString = `${minutes}åˆ†${seconds}ç§’`;

            const percentage = Math.round((score / quizData.length) * 100);
            document.getElementById('score-text').innerHTML = `${quizData.length} å•ä¸­ ${score} å•æ­£è§£ï¼ (æ­£ç­”ç‡: ${percentage}%)<br>ã‹ã‹ã£ãŸæ™‚é–“: ${timeString}`;

            let msg = "";
            if (percentage === 100) {
                msg = "å®Œç’§ã§ã™ï¼";
                confetti({
                    particleCount: 150,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            } else if (percentage >= 80) {
                msg = "ç´ æ™´ã‚‰ã—ã„ï¼";
                confetti({
                    particleCount: 100,
                    spread: 70,
                    origin: { y: 0.6 }
                });
            } else {
                msg = "å¾©ç¿’ã—ã¾ã—ã‚‡ã†ã€‚";
            }
            document.getElementById('final-message').textContent = msg;

            // ãƒªãƒˆãƒ©ã‚¤ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            const retryBtn = document.getElementById('retry-btn');
            if (incorrectQuestions.length > 0) {
                retryBtn.style.display = 'inline-block';
                retryBtn.textContent = `ğŸ”¥ é–“é•ãˆãŸå•é¡Œã ã‘ãƒªãƒˆãƒ©ã‚¤ (${incorrectQuestions.length}å•)`;
            } else {
                retryBtn.style.display = 'none';
            }
        });

        function retryIncorrect() {
            if (incorrectQuestions.length === 0) return;

            // é–“é•ãˆãŸå•é¡Œã ã‘ã§ã‚¯ã‚¤ã‚ºã‚’å†æ§‹æˆ
            quizData = [...incorrectQuestions];
            incorrectQuestions = []; // ãƒªã‚»ãƒƒãƒˆï¼ˆãƒªãƒˆãƒ©ã‚¤ä¸­ã«ã•ã‚‰ã«é–“é•ãˆãŸã‚‰ã¾ãŸè¿½åŠ ã•ã‚Œã‚‹ã‚ˆã†ã«ï¼‰
            currentQuestionIndex = 0;
            score = 0;

            // ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
            document.getElementById('results-container').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'block';

            startTime = Date.now(); // ãƒªãƒˆãƒ©ã‚¤æ™‚ã‚‚ã‚¿ã‚¤ãƒãƒ¼ãƒªã‚»ãƒƒãƒˆ
            loadQuestion();
        }

        function sendResults() {
            // å…±é€šè¨­å®šã‹ã‚‰èª­ã¿è¾¼ã¿
            let name = localStorage.getItem('quiz_student_name') || "";
            let GAS_URL = localStorage.getItem('quiz_gas_url') || "";

            const statusEl = document.getElementById('send-status');

            if (!name) {
                alert("ãŠåå‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ï¼ˆæ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ï¼‰ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            statusEl.textContent = "é€ä¿¡ä¸­...";

            if (!GAS_URL) {
                statusEl.textContent = "âš ï¸ ã‚¨ãƒ©ãƒ¼: GAS URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
                alert("ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§GAS URLã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            const endTime = Date.now();
            const elapsedSeconds = Math.floor((endTime - startTime) / 1000);
            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            const timeString = `${minutes}åˆ†${seconds}ç§’`;

            const data = {
                quizName: document.querySelector('h1').textContent, // ã‚¿ã‚¤ãƒˆãƒ«ã‚’é€ä¿¡
                name: name,
                score: score,
                total: quizData.length,
                time: timeString
            };

            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors', // CORSå›é¿ã®ãŸã‚no-corsï¼ˆãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯èª­ã‚ãªã„ãŒé€ä¿¡ã¯ã§ãã‚‹ï¼‰
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(() => {
                    statusEl.textContent = "âœ… é€ä¿¡ã—ã¾ã—ãŸï¼";
                    statusEl.style.color = "green";
                    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦é€£æ‰“é˜²æ­¢
                    document.querySelector('button[onclick="sendResults()"]').disabled = true;
                })
                .catch(err => {
                    console.error(err);
                    statusEl.textContent = "âŒ é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                    statusEl.style.color = "red";
                });
        }

        // --- åŠ¹æœéŸ³æ©Ÿèƒ½ ---
        function initAudioContext() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;

            // Create/Resume AudioContext on user action
            const unlockAudio = () => {
                if (!audioCtx) {
                    audioCtx = new AudioContext();
                }
                if (audioCtx.state === 'suspended') {
                    audioCtx.resume();
                }

                // Play silent buffer to force wake up audio engine (iOS fix)
                const buffer = audioCtx.createBuffer(1, 1, 22050);
                const source = audioCtx.createBufferSource();
                source.buffer = buffer;
                source.connect(audioCtx.destination);
                source.start(0);

                // Remove event listeners (only need once)
                document.removeEventListener('click', unlockAudio);
                document.removeEventListener('touchstart', unlockAudio);
                document.removeEventListener('keydown', unlockAudio);
            };

            document.addEventListener('click', unlockAudio);
            document.addEventListener('touchstart', unlockAudio);
            document.addEventListener('keydown', unlockAudio);
        }

        function toggleSound() {
            isSoundOn = !isSoundOn;
            const btn = document.getElementById('sound-toggle');
            btn.textContent = isSoundOn ? 'ğŸ”Š' : 'ğŸ”‡';
        }

        function playSound(type) {
            if (!isSoundOn) return;

            // Try to create/resume AudioContext if missing or closed
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;

            if (!audioCtx) {
                audioCtx = new AudioContext();
            }

            if (audioCtx.state === 'suspended') {
                audioCtx.resume().catch(e => console.log("Audio resume failed:", e));
            }

            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();

            osc.connect(gain);
            gain.connect(audioCtx.destination);

            if (type === 'correct') {
                // Ping-pong (high pitch x2)
                osc.type = 'sine';
                osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
                osc.frequency.setValueAtTime(1500, audioCtx.currentTime + 0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            } else if (type === 'incorrect') {
                // Buzzer (low saw wave)
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(150, audioCtx.currentTime);
                osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
                osc.start();
                osc.stop(audioCtx.currentTime + 0.3);
            }
        }

        // --- ç™½ç´™åˆ¤å®š ---
        function isCanvasBlank(canvas) {
            const context = canvas.getContext('2d', { willReadFrequently: true });
            const pixelBuffer = new Uint32Array(
                context.getImageData(0, 0, canvas.width, canvas.height).data.buffer
            );
            return !pixelBuffer.some(color => color !== 0);
        }

        // --- ã‚­ãƒ£ãƒ³ãƒã‚¹æ©Ÿèƒ½ ---
        function initCanvas() {
            canvas = document.getElementById('memo-pad');
            ctx = canvas.getContext('2d', { willReadFrequently: true });
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            resizeCanvas();
            // resizeCanvasã¯åˆæœŸã‚µã‚¤ã‚ºè¨­å®šã‚’è¡Œã†
            window.addEventListener('resize', resizeCanvas);
            canvas.addEventListener('contextmenu', (e) => e.preventDefault());

            if (window.PointerEvent) {
                // Pointer Events (ãƒ¢ãƒ€ãƒ³ãƒ–ãƒ©ã‚¦ã‚¶ãƒ»ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå‘ã‘)
                canvas.addEventListener('pointerdown', (e) => {
                    e.preventDefault();
                    if (isPenOnlyMode && e.pointerType === 'touch') {
                        return;
                    }
                    canvas.setPointerCapture(e.pointerId);
                    startDrawing(e);
                });

                canvas.addEventListener('pointermove', (e) => {
                    e.preventDefault();
                    if (isPenOnlyMode && e.pointerType === 'touch') {
                        return;
                    }

                    // è£œé–“ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆCoalesced Eventsï¼‰ã®å‡¦ç†
                    // ã“ã‚Œã«ã‚ˆã‚Šã€æç”»ãƒã‚¤ãƒ³ãƒˆãŒå¢—ãˆã€ç·šãŒæ»‘ã‚‰ã‹ã«ãªã‚Šã¾ã™
                    if (e.getCoalescedEvents) {
                        const events = e.getCoalescedEvents();
                        for (const event of events) {
                            draw(event);
                        }
                    } else {
                        draw(e);
                    }
                    updateCursor(e);
                });

                canvas.addEventListener('pointerup', (e) => {
                    e.preventDefault();
                    canvas.releasePointerCapture(e.pointerId);
                    stopDrawing();
                    updateCursor(e);
                });
                canvas.addEventListener('pointerenter', (e) => {
                    if (currentTool === 'eraser') {
                        document.getElementById('eraser-cursor').style.display = 'block';
                    }
                });
                canvas.addEventListener('pointerleave', (e) => {
                    document.getElementById('eraser-cursor').style.display = 'none';
                });
                canvas.addEventListener('pointercancel', (e) => {
                    canvas.releasePointerCapture(e.pointerId);
                    stopDrawing();
                });
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ (å¤ã„ãƒ–ãƒ©ã‚¦ã‚¶ç”¨)
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);

                canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (isPenOnlyMode) return;
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent("mousedown", { clientX: touch.clientX, clientY: touch.clientY });
                    canvas.dispatchEvent(mouseEvent);
                }, { passive: false });

                canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (isPenOnlyMode) return;
                    // Touch events do not support coalesced events in the same way directly here
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent("mousemove", { clientX: touch.clientX, clientY: touch.clientY });
                    canvas.dispatchEvent(mouseEvent);
                }, { passive: false });

                canvas.addEventListener('touchend', () => {
                    if (isPenOnlyMode) return;
                    canvas.dispatchEvent(new MouseEvent("mouseup", {}));
                });
            }
        }

        function resizeCanvas() {
            const container = document.getElementById('memo-container');
            const dpr = window.devicePixelRatio || 1;

            // ç¾åœ¨ã®æç”»å†…å®¹ã‚’ä¸€æ™‚ä¿å­˜
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');
            if (canvas.width > 0 && canvas.height > 0) {
                tempCtx.drawImage(canvas, 0, 0);
            }

            // ã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºã‚’å–å¾—
            const rect = container.getBoundingClientRect();

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®å®Ÿã‚µã‚¤ã‚ºã‚’DPIã«åˆã‚ã›ã¦è¨­å®š
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;

            // CSSã‚µã‚¤ã‚ºã¯ã‚³ãƒ³ãƒ†ãƒŠã«åˆã‚ã›ã‚‹
            canvas.style.width = `${rect.width}px`;
            canvas.style.height = `${rect.height}px`;

            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è¨­å®š
            // ã“ã‚Œã«ã‚ˆã‚Šã€ä»¥å¾Œã®æç”»åº§æ¨™ï¼ˆCSSãƒ”ã‚¯ã‚»ãƒ«å˜ä½ï¼‰ãŒè‡ªå‹•çš„ã«DPIã«åˆã‚ã›ã¦æ‹¡å¤§ã•ã‚Œã‚‹
            ctx.scale(dpr, dpr);

            // æç”»å†…å®¹ã‚’å¾©å…ƒ (ãƒ”ã‚¯ã‚»ãƒ«ç­‰å€ã§æ›¸ãæˆ»ã™)
            if (tempCanvas.width > 0 && tempCanvas.height > 0) {
                ctx.save();
                ctx.resetTransform(); // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’ä¸€æ™‚çš„ã«è§£é™¤
                ctx.drawImage(tempCanvas, 0, 0);
                ctx.restore();
            }
        }

        function startDrawing(e) {
            isDrawing = true;
            draw(e);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.lineCap = 'round';
            ctx.lineJoin = 'round'; // è§’ã‚’ä¸¸ãã™ã‚‹

            if (currentTool === 'pen') {
                ctx.globalCompositeOperation = 'source-over';
                ctx.lineWidth = 3;
                ctx.strokeStyle = currentPenColor;
            } else if (currentTool === 'pen-red') {
                ctx.globalCompositeOperation = 'source-over';
                ctx.lineWidth = 3;
                ctx.strokeStyle = '#ff0000';
            } else if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 20;
                ctx.strokeStyle = 'rgba(0,0,0,1)';
            }

            ctx.lineTo(x, y);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function stopDrawing() {
            isDrawing = false;
            ctx.beginPath();
            saveMemoState();
        }

        function updateCursor(e) {
            const cursor = document.getElementById('eraser-cursor');
            if (currentTool === 'eraser') {
                cursor.style.display = 'block';
                // Cursor position logic (simple following)
                const rect = canvas.getBoundingClientRect();
                cursor.style.left = (e.clientX - rect.left - 10) + 'px'; // Center roughly (assuming 20px cursor)
                cursor.style.top = (e.clientY - rect.top - 10) + 'px';
            } else {
                cursor.style.display = 'none';
            }
        }

        function saveMemoState() {
            // å±¥æ­´ã¯æœ€å¤§10ä»¶ã¾ã§
            if (memoHistory.length >= 10) {
                memoHistory.shift();
            }
            memoHistory.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        }

        function undoMemo() {
            if (memoHistory.length > 0) {
                const lastState = memoHistory.pop();
                ctx.putImageData(lastState, 0, 0);
            }
        }

        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            if (tool === 'pen') {
                document.getElementById('btn-pen').classList.add('active');
                document.getElementById('eraser-cursor').style.display = 'none';
            } else if (tool === 'pen-red') {
                document.getElementById('btn-pen-red').classList.add('active');
                document.getElementById('eraser-cursor').style.display = 'none';
            } else if (tool === 'eraser') {
                document.getElementById('btn-eraser').classList.add('active');
            }
        }

        function clearMemo() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function saveMemo() {
            // html2canvasã‚’ä½¿ã£ã¦ãƒ¡ãƒ¢ã‚³ãƒ³ãƒ†ãƒŠå…¨ä½“ï¼ˆå•é¡Œæ–‡å«ã‚€ï¼‰ã‚’ç”»åƒåŒ–
            const element = document.getElementById('memo-container');
            const overlay = document.getElementById('memo-question-overlay');
            const wasHidden = (overlay.style.display === 'none' || overlay.style.display === '');

            // ä¿å­˜æ™‚ã®ã¿ä¸€æ™‚çš„ã«å•é¡Œæ–‡ã‚’è¡¨ç¤º
            if (wasHidden) {
                overlay.style.display = 'block';
                // æ•°å¼ãªã©ãŒæ­£ã—ããƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆéè¡¨ç¤ºã ã¨å´©ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ãŸã‚å¿µã®ãŸã‚ï¼‰
                renderAllMath();
            }

            html2canvas(element, {
                backgroundColor: isDarkMode ? '#121212' : '#ffffff', // èƒŒæ™¯è‰²ã‚’æ˜ç¤º
                scale: 2 // é«˜è§£åƒåº¦ã§å–å¾—
            }).then(canvas => {
                // å…ƒã®çŠ¶æ…‹ã«æˆ»ã™ï¼ˆã‚­ãƒ£ãƒ—ãƒãƒ£å®Œäº†å¾Œã™ãã«æˆ»ã™ï¼‰
                if (wasHidden) {
                    overlay.style.display = 'none';
                }

                const now = new Date();
                const dateStr = now.getFullYear() +
                    ('0' + (now.getMonth() + 1)).slice(-2) +
                    ('0' + now.getDate()).slice(-2) + '_' +
                    ('0' + now.getHours()).slice(-2) +
                    ('0' + now.getMinutes()).slice(-2) +
                    ('0' + now.getSeconds()).slice(-2);
                const fileName = `memo_${dateStr}.png`;

                canvas.toBlob(async (blob) => {
                    if (!blob) return;

                    const file = new File([blob], fileName, { type: 'image/png' });

                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                    const previewImg = document.getElementById('preview-image');
                    previewImg.src = URL.createObjectURL(blob);

                    // ã‚·ã‚§ã‚¢ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
                    const shareBtn = document.getElementById('preview-share-btn');
                    if (navigator.canShare && navigator.canShare({ files: [file] })) {
                        shareBtn.style.display = 'inline-block';
                        shareBtn.onclick = async () => {
                            try {
                                await navigator.share({
                                    files: [file],
                                    title: 'ãƒ¡ãƒ¢ã‚’ä¿å­˜',
                                    text: 'ãƒ¡ãƒ¢ç”»åƒã‚’ä¿å­˜ã—ã¾ã™'
                                });
                            } catch (err) {
                                console.log('Share cancelled or failed', err);
                            }
                        };
                    } else {
                        shareBtn.style.display = 'none';
                    }

                    document.getElementById('image-preview-modal').style.display = 'flex';
                });
            });
        }

        function closeImagePreview() {
            document.getElementById('image-preview-modal').style.display = 'none';
            // ãƒ¡ãƒ¢ãƒªè§£æ”¾ã®ãŸã‚ã«URLã‚’revokeï¼ˆå¿µã®ãŸã‚ï¼‰
            const img = document.getElementById('preview-image');
            if (img.src) URL.revokeObjectURL(img.src);
            img.src = '';
        }

        function downloadImage(canvas, fileName) {
            const link = document.createElement('a');
            link.download = fileName;
            link.href = canvas.toDataURL('image/png');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function toggleQuestionOverlay() {
            const overlay = document.getElementById('memo-question-overlay');
            const btn = document.getElementById('btn-toggle-question');
            if (overlay.style.display === 'none' || overlay.style.display === '') {
                overlay.style.display = 'block';
                btn.classList.add('active');
                renderAllMath(); // æ•°å¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            } else {
                overlay.style.display = 'none';
                btn.classList.remove('active');
            }
        }

        function togglePenOnly() {
            isPenOnlyMode = !isPenOnlyMode;
            const btn = document.getElementById('btn-pen-only');
            if (isPenOnlyMode) {
                btn.innerHTML = 'ğŸ–Šï¸ ãƒšãƒ³ã®ã¿';
                btn.classList.add('active');
            } else {
                btn.innerHTML = 'ğŸ–ï¸ æ‰‹æ›¸ã';
                btn.classList.remove('active');
            }
        }

        // --- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ ---
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode');
            const btn = document.getElementById('dark-mode-toggle');
            btn.textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';

            // è¨­å®šã‚’ä¿å­˜
            localStorage.setItem('darkMode', isDarkMode);

            // ãƒšãƒ³ã®è‰²ã‚’å¤‰æ›´
            currentPenColor = isDarkMode ? '#fff' : '#000';

            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®è‰²åè»¢
            invertCanvas();
        }

        function invertCanvas() {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;

            for (let i = 0; i < data.length; i += 4) {
                // ã‚¢ãƒ«ãƒ•ã‚¡å€¤ãŒ0ã§ãªã„ï¼ˆæç”»ã•ã‚Œã¦ã„ã‚‹ï¼‰ãƒ”ã‚¯ã‚»ãƒ«ã®ã¿å‡¦ç†
                if (data[i + 3] > 0) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];

                    // ã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆé»’ãƒ»ç™½ãƒ»ã‚°ãƒ¬ãƒ¼ï¼‰ã®å ´åˆã®ã¿åè»¢
                    // ã“ã‚Œã«ã‚ˆã‚Šèµ¤è‰²ãªã©ã¯ãã®ã¾ã¾ç¶­æŒã•ã‚Œã‚‹
                    if (r === g && g === b) {
                        data[i] = 255 - r;     // R
                        data[i + 1] = 255 - g; // G
                        data[i + 2] = 255 - b; // B
                    }
                }
            }
            ctx.putImageData(imageData, 0, 0);

            // å±¥æ­´ã‚‚åè»¢ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€ä»Šå›ã¯ç°¡æ˜“çš„ã«å±¥æ­´ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
            memoHistory = [];
        }

        // --- ãƒ¬ã‚¸ãƒ¥ãƒ¼ãƒ æ©Ÿèƒ½ ---
        function toggleResume() {
            isResumeOn = !isResumeOn;
            localStorage.setItem('resumeOn', isResumeOn);
            updateResumeButton();

            if (!isResumeOn) {
                clearProgress(); // OFFã«ã—ãŸã‚‰ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆã™ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            } else {
                saveProgress(); // ONã«ã—ãŸã‚‰å³ä¿å­˜
            }
        }

        function updateResumeButton() {
            const btn = document.getElementById('resume-toggle');
            if (isResumeOn) {
                btn.textContent = 'ğŸ“‚';
                btn.style.opacity = '1';
            } else {
                btn.textContent = 'ğŸ“'; // é–‰ã˜ãŸãƒ•ã‚©ãƒ«ãƒ€ãªã©
                btn.style.opacity = '0.5';
            }
        }

        function saveProgress() {
            if (!isResumeOn) return;

            const data = {
                quizData: quizData,
                currentQuestionIndex: currentQuestionIndex,
                score: score,
                incorrectQuestions: incorrectQuestions,
                startTime: startTime,
                timestamp: Date.now()
            };
            localStorage.setItem('quiz_progress_M1-1-1-1', JSON.stringify(data));
        }

        function restoreProgress(data) {
            // ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒ
            quizData = data.quizData;
            currentQuestionIndex = data.currentQuestionIndex;
            score = data.score;
            incorrectQuestions = data.incorrectQuestions || [];
            startTime = data.startTime || Date.now(); // ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚é–“ãŒãªã‘ã‚Œã°ç¾åœ¨æ™‚åˆ»

            loadQuestion();
        }

        function clearProgress() {
            localStorage.removeItem('quiz_progress_M1-1-1-1');
        }

        // --- ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³æ©Ÿèƒ½ ---
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            } else {
                document.exitFullscreen();
            }
        }

        // ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã®ç›£è¦–ï¼ˆã‚¢ã‚¤ã‚³ãƒ³åˆ‡ã‚Šæ›¿ãˆç”¨ï¼‰
        document.addEventListener('fullscreenchange', () => {
            const btn = document.getElementById('fullscreen-toggle');
            if (document.fullscreenElement) {
                btn.textContent = 'ğŸ—•'; // ç¸®å°ã‚¢ã‚¤ã‚³ãƒ³
            } else {
                btn.textContent = 'â›¶'; // æ‹¡å¤§ã‚¢ã‚¤ã‚³ãƒ³
            }
        });

        // --- AIåˆ†æ ---
        async function analyzeError() {
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-content');
            modal.style.display = 'flex';
            content.innerHTML = '<p>AIã‚«ã‚¬ãƒ¯å…ˆç”ŸãŒåˆ†æä¸­ãƒ»ãƒ»ãƒ»<br><span style="font-size:2em;">ğŸ¤–ğŸ’­</span></p>';

            const apiKey = localStorage.getItem('gemini_api_key');
            if (!apiKey) {
                content.innerHTML = `
                    <p>APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                    <p><a href="index.html" target="_blank">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</a>ã®ã€ŒAPIã‚­ãƒ¼è¨­å®šã€ã‹ã‚‰ã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>
                    <button class="tool-btn" onclick="closeAiModal()">é–‰ã˜ã‚‹</button>
                `;
                return;
            }

            const currentQuestion = quizData[currentQuestionIndex];

            try {
                // html2canvaså»ƒæ­¢ -> ç›´æ¥ã‚­ãƒ£ãƒ³ãƒã‚¹ã‹ã‚‰ç”»åƒã‚’ç”Ÿæˆ
                const imageData = getCanvasImageBase64(1);

                const prompt = `
ã‚ãªãŸã¯é«˜æ ¡æ•°å­¦ã®ã€Œèª¤ã‚Šè¨ºæ–­ã€ã«ç‰¹åŒ–ã—ãŸæ·»å‰Šè€…ã§ã™ã€‚
ä»¥ä¸‹ã®å•é¡Œã«å¯¾ã™ã‚‹ç”Ÿå¾’ã®æ‰‹æ›¸ãè§£ç­”ï¼ˆç”»åƒï¼‰ã‚’èª­ã¿å–ã‚Šï¼Œ
æœ€çµ‚ç­”æ¡ˆã®æ­£èª¤ã¨ï¼Œé€”ä¸­å¼ã®æ•°å­¦çš„æ•´åˆæ€§ã ã‘ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

ã€é‡è¦ç¢ºèªäº‹é …ã€‘
- ç”»åƒã¯æ‰‹æ›¸ãã®æ–‡å­—ã§ã™ã€‚ç‰¹ã«**æ•°å­—ã®ã€Œ0ã€ã‚„ã€Œ6ã€ã€Œ8ã€ã€Œ9ã€ãªã©ã®é–‰ã˜ãŸæ•°å­—**ã‚’æ³¨æ„æ·±ãèª­ã¿å–ã£ã¦ãã ã•ã„ã€‚
- å°‘ã—ç·šãŒé›¢ã‚Œã¦ã„ãŸã‚Šã€ã‹ã™ã‚Œã¦ã„ã¦ã‚‚ã€æ•°å­¦çš„ãªæ–‡è„ˆã‹ã‚‰æ•°å­—ã‚’æ¨æ¸¬ã—ã¦ãã ã•ã„ã€‚
- å°ã•ãªä¸¸ã‚„ç‚¹ã‚‚ã€Œ0ã€ã‚„ã€Œå°æ•°ç‚¹ã€ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

å•é¡Œ: ${currentQuestion.question}
æ­£è§£: ${currentQuestion.answer}

ã€æœ€é‡è¦ãƒ«ãƒ¼ãƒ«ã€‘
0. ã€æœ€é‡è¦ã€‘ç”»åƒã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‰‹æ›¸ããŒå…¨ãè¦‹å½“ãŸã‚‰ãªã„ï¼ˆç™½ç´™ï¼‰å ´åˆã¯ã€çµ¶å¯¾ã«ã€Œä¸æ­£è§£ã€ã¨åˆ¤å®šã—ã€isCorrect: false ã‚’è¿”ã—ã¦ãã ã•ã„ã€‚ã€Œå›ç­”ãŒè¦‹å½“ãŸã‚Šã¾ã›ã‚“ã€ã¨æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚
1. ç”»åƒã«ä½•ã‚‚æ›¸ã‹ã‚Œã¦ã„ãªã„ï¼Œã¾ãŸã¯ç™½ç´™ã«è¿‘ã„å ´åˆã¯å¿…ãšä¸æ­£è§£ã¨ã™ã‚‹ã€‚
2. ãã®å ´åˆã¯ä»¥ä¸‹ã®JSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦çµ‚äº†ã™ã‚‹ï¼š
   {"isCorrect": false, "hasProcessError": false, "recognizedAnswer": "", "feedback": "ãƒ¡ãƒ¢å¸³ã«è¨˜è¿°ãŒãªã„å ´åˆã¯åˆ†æãŒã§ããªã„ã®ã§ï¼Œè§£ç­”ã¯ãƒ¡ãƒ¢å¸³ã«æ›¸ã„ã¦ãã ã•ã„ã­ï¼"}
3. æœ€çµ‚ç­”æ¡ˆãŒæ­£è§£ã¨ä¸€è‡´ã—ã¦ã„ã‚‹å ´åˆã®ã¿ isCorrect ã‚’ true ã¨ã™ã‚‹ã€‚
   - æœ‰ç†åŒ–ã§åŒã˜ï¼ŒåŒå€¤å¤‰å½¢ï¼Œç©ã®é †åºé•ã„ãªã©ã¯æ­£è§£æ‰±ã„ã€‚
4. é€”ä¸­å¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ï¼Œå¿…ãšé€”ä¸­å¼ã®æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚
5. æœ€çµ‚ç­”æ¡ˆãŒæ­£è§£ã§ã‚‚é€”ä¸­å¼ã«æ•°å­¦çš„ãªèª¤ã‚Šã‚„é£›èºãŒã‚ã‚‹å ´åˆï¼Œ
   hasProcessError ã‚’ true ã¨ã—ï¼Œ
   feedback ã§çŸ­ãæŒ‡æ‘˜ã™ã‚‹ã€‚
6. é€”ä¸­å¼ãŒã»ã¼ç„¡ã„/èª­ã‚ãªã„å ´åˆã¯ hasProcessError ã‚’ false ã«ã—ã¦ã‚ˆã„ãŒï¼Œ
   feedback ã«ã€Œé€”ä¸­å¼ãŒèª­ã¿å–ã‚Œãªã„ãŸã‚éç¨‹ã®æ¤œè¨¼ã¯ä¸ååˆ†ã€ã¨çŸ­ãæ›¸ãã€‚
7. é–“é•ã„ã®è¦å› ã¨ã—ã¦ã€Œè¨ˆç®—ãƒŸã‚¹ã€ã ã‘ã§ãªã
   ã€Œæ•°å¼ã®å†™ã—é–“é•ã„ï¼ˆå•é¡Œæ–‡ã®å¼ã‚„æ¡ä»¶ã®è»¢è¨˜ãƒŸã‚¹ï¼‰ã€ã‚‚é‡è¦ãªèª¤ã‚Šã¨ã—ã¦æ‰±ã„ï¼Œ
   å¯èƒ½ãªã‚‰å„ªå…ˆã—ã¦æŒ‡æ‘˜ã™ã‚‹ã€‚
8. æ­£èª¤åˆ¤å®šå•é¡Œï¼ˆç­”ãˆãŒã€Œæ­£ã—ã„ã€ã€Œæ­£ã—ããªã„ã€ã®å ´åˆï¼‰ã«ã¤ã„ã¦:
   - æ¼¢å­—ã®å´©ã‚Œã‚„ã²ã‚‰ãŒãªè¡¨è¨˜ï¼ˆä¾‹ï¼šã€ŒãŸã ã—ã„ã€ï¼‰ã§ã‚‚æ„å›³ãŒæ˜ç¢ºãªã‚‰æ¡ç‚¹ã€‚
   - ã€Œã€‡ã€ã€ŒÃ—ã€ã¯ãã‚Œãã‚Œã€Œæ­£ã—ã„ã€ã€Œæ­£ã—ããªã„ã€ã«å¯¾å¿œã•ã›ã¦æ¡ç‚¹ã€‚
9. æ•°å¼ã¯å¿…ãšLaTeXå½¢å¼ï¼ˆ$...$ï¼‰ã§è¨˜è¿°ã™ã‚‹ã€‚åˆ†æ•°ã¯ \\\\frac{a}{b} ã‚’ç”¨ã„ã‚‹ã€‚
   é›†åˆè¨˜å·ï¼ˆ\\\\subset,\\\\subseteq,\\\\supset,\\\\supseteq,\\\\in,\\\\notin,\\\\cup,\\\\cap,\\\\emptyset ãªã©ï¼‰ã‚‚
   å¿…ãš $...$ ã®ä¸­ã«å…¥ã‚Œã‚‹ã€‚
   ä¾‹ï¼šã€ŒAã¯Bã®éƒ¨åˆ†é›†åˆãªã®ã§ $A \\\\subset B$ã€ã€‚
10. JSONå‡ºåŠ›æ™‚ã€æ–‡å­—åˆ—å†…ã®ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã¯å¿…ãšã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦ã€Œ\\\\ã€ã¨è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚ï¼ˆä¾‹ï¼šã€Œ\\\\{ã€ã§ã¯ãªãã€Œ\\\\\\\\{ã€ï¼‰

ã€feedbackã®æ›¸ãæ–¹ï¼ˆã‚„ã•ã—ãçŸ­ãï¼‰ã€‘
- 50ã€œ120å­—ç¨‹åº¦ã€‚
- æŒ‡æ‘˜ã¯æœ€å¤§2ç‚¹ã¾ã§ã€‚
- è§£èª¬ã‚„æ¨¡ç¯„è§£ç­”ã®å†æç¤ºã¯ç¦æ­¢ï¼ˆè§£èª¬ã¯åˆ¥ã«è¡¨ç¤ºã•ã‚Œã‚‹ï¼‰ã€‚
- èª¤ã‚Šã‚¿ã‚¤ãƒ—ã®ä¾‹ï¼š
  è¨ˆç®—ãƒŸã‚¹ï¼ç¬¦å·ãƒŸã‚¹ï¼å…¬å¼ã®é©ç”¨æ¡ä»¶ãƒŸã‚¹ï¼åŒå€¤å¤‰å½¢ã®èª¤ã‚Šï¼è«–ç†ã®é£›èºï¼å†™ã—é–“é•ã„
- ä¸æ­£è§£ã®å ´åˆã¯æœ€ã‚‚è‡´å‘½çš„ãªèª¤ã‚Šç®‡æ‰€ã‚’å„ªå…ˆã—ã¦æŒ‡æ‘˜ã€‚
- æ­£è§£ã ãŒ hasProcessError ãŒ true ã®å ´åˆã¯
  ã€Œç­”ãˆã¯åˆã£ã¦ã„ã¾ã™ãŒï¼Œé€”ä¸­å¼ã«èª¤ã‚ŠãŒè¦‹ã‚‰ã‚Œã¾ã™ã€‚ã€ã®ã‚ˆã†ã«è‡ªç„¶ãªè¡¨ç¾ã§çŸ­ãæŒ‡æ‘˜ã€‚

ã€å‡ºåŠ›ã€‘
ä»¥ä¸‹ã®JSONå½¢å¼ã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚Markdownã®ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ä¸è¦ã§ã™ã€‚
{
  "isCorrect": true ã¾ãŸã¯ false,
  "hasProcessError": true ã¾ãŸã¯ false,
  "recognizedAnswer": "ç”»åƒã‹ã‚‰èª­ã¿å–ã£ãŸç”Ÿå¾’ã®æœ€çµ‚è§£ç­”ï¼ˆLaTeX $...$ï¼‰ã€‚èª­ã¿å–ã‚Œãªã„å ´åˆã¯ç©ºæ–‡å­—ã€‚",
  "feedback": "èª¤ã‚Šè¨ºæ–­ã‚³ãƒ¡ãƒ³ãƒˆã€‚æ­£è§£ã‹ã¤éç¨‹ã‚‚å•é¡Œãªã‘ã‚Œã°ç©ºæ–‡å­—ã€‚"
}
`;


                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç’°å¢ƒã§åˆ©ç”¨å¯èƒ½ãª gemini-2.0-flash ã‚’ä½¿ç”¨ (v1beta)
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                {
                                    inline_data: {
                                        mime_type: "image/png",
                                        data: imageData
                                    }
                                }
                            ]
                        }]
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API Error: ${response.status} - ${errorText}`);
                }

                const data = await response.json();

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã®ãƒã‚§ãƒƒã‚¯
                if (!data.candidates || data.candidates.length === 0 || !data.candidates[0].content) {
                    throw new Error("No candidates returned from API");
                }

                const aiText = data.candidates[0].content.parts[0].text;

                content.innerHTML = `
                    <h4>ğŸ¤– AIã‚«ã‚¬ãƒ¯å…ˆç”Ÿã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h4>
                    <p>${aiText.replace(/\\n/g, '<br>')}</p>
                    <button class="tool-btn" onclick="closeAiModal()">é–‰ã˜ã‚‹</button>
                `;

                // KaTeXãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’é©ç”¨
                renderAllMath();

            } catch (error) {
                console.error(error);
                let errorMsg = "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚";
                if (error.message.includes("404")) {
                    errorMsg = "ãƒ¢ãƒ‡ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (404)ã€‚APIã‚­ãƒ¼ã¾ãŸã¯ãƒ¢ãƒ‡ãƒ«åã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                } else if (error.message.includes("400")) {
                    errorMsg = "ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒä¸æ­£ã§ã™ (400)ã€‚APIã‚­ãƒ¼ãŒç„¡åŠ¹ãªå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚";
                } else if (error.message.includes("403")) {
                    errorMsg = "ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“ (403)ã€‚APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚";
                } else if (error.message.includes("429")) {
                    errorMsg = "ãƒªã‚¯ã‚¨ã‚¹ãƒˆå›æ•°åˆ¶é™ã‚’è¶…ãˆã¾ã—ãŸ (429)ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚";
                } else {
                    errorMsg = error.message;
                }

                content.innerHTML = `
                    <p>åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚</p>
                    <p style="color:red; font-size:0.9em;">${errorMsg}</p>
                    <p>è©³ç´°: <span style="font-size:0.8em; color:#666;">${error.message}</span></p>
                    <button class="tool-btn" onclick="closeAiModal()">é–‰ã˜ã‚‹</button>
                `;
            }
        }

        function closeAiModal() {
            document.getElementById('ai-modal').style.display = 'none';
        }

        // --- èª­ã¿ä¸Šã’ ---
        window.speakRationale = function (btn) {
            if (synth.speaking) { synth.cancel(); return; }
            // ç°¡æ˜“å®Ÿè£…
            const text = btn.parentElement.innerText.replace(/ğŸ”Š/g, '');
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'ja-JP';
            synth.speak(u);
        };

        function renderAllMath() {
            if (window.renderMathInElement) {
                renderMathInElement(document.body, {
                    delimiters: [
                        { left: '$$', right: '$$', display: true },
                        { left: '$', right: '$', display: false }
                    ],
                    throwOnError: false
                });
            }
        }
        // --- ãƒªã‚µã‚¤ã‚¶ãƒ¼æ©Ÿèƒ½ ---
        const resizer = document.getElementById('resizer');
        const leftPanel = document.getElementById('left-panel');
        const rightPanel = document.getElementById('right-panel');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('active');
            document.body.style.cursor = 'col-resize';
            // é¸æŠé˜²æ­¢
            document.body.style.userSelect = 'none';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const containerWidth = document.body.clientWidth;
            const x = e.clientX;
            const leftWidthPercent = (x / containerWidth) * 100;

            if (leftWidthPercent > 10 && leftWidthPercent < 90) {
                leftPanel.style.flex = `0 0 ${leftWidthPercent}vw`;
                leftPanel.style.width = `${leftWidthPercent}vw`;
                rightPanel.style.flex = `0 0 ${100 - leftWidthPercent}vw`;
                rightPanel.style.width = `${100 - leftWidthPercent}vw`;
                resizeCanvas();
            }
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('active');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
                resizeCanvas();
            }
        });

        // ã‚¿ãƒƒãƒå¯¾å¿œ
        resizer.addEventListener('touchstart', (e) => {
            isResizing = true;
            resizer.classList.add('active');
        }, { passive: false });

        document.addEventListener('touchmove', (e) => {
            if (!isResizing) return;
            const touch = e.touches[0];
            const containerWidth = document.body.clientWidth;
            const x = touch.clientX;
            const leftWidthPercent = (x / containerWidth) * 100;

            if (leftWidthPercent > 10 && leftWidthPercent < 90) {
                leftPanel.style.flex = `0 0 ${leftWidthPercent}vw`;
                leftPanel.style.width = `${leftWidthPercent}vw`;
                rightPanel.style.flex = `0 0 ${100 - leftWidthPercent}vw`;
                rightPanel.style.width = `${100 - leftWidthPercent}vw`;
                resizeCanvas();
            }
        }, { passive: false });

        document.addEventListener('touchend', () => {
            if (isResizing) {
                isResizing = false;
                resizer.classList.remove('active');
                resizeCanvas();
            }
        });

    </script>
    <!-- Image Preview Modal -->
    <div id="image-preview-modal">
        <img id="preview-image" src="" alt="Memo Preview">
        <p class="save-hint">ç”»åƒã‚’é•·æŠ¼ã—ã—ã¦ã€Œå†™çœŸã€ã«ä¿å­˜ã—ã¦ãã ã•ã„</p>
        <div class="modal-controls">
            <button id="preview-share-btn" class="share-btn">å…±æœ‰ / ä»–ã®ã‚¢ãƒ—ãƒªã§é–‹ã</button>
            <button class="close-btn" onclick="closeImagePreview()">é–‰ã˜ã‚‹</button>
        </div>
    </div>
    <!-- Version Info -->
    <script>
        (function(){
            const APP_VERSION = "v1.1.0";
            if (!document.getElementById('app-version')) {
                const vDiv = document.createElement('div');
                vDiv.id = 'app-version';
                vDiv.textContent = APP_VERSION;
                Object.assign(vDiv.style, {
                    position: 'fixed',
                    bottom: '5px',
                    right: '10px',
                    fontSize: '12px',
                    color: 'rgba(0,0,0,0.3)',
                    pointerEvents: 'none',
                    zIndex: '9999',
                    fontFamily: 'sans-serif'
                });
                document.body.appendChild(vDiv);
            }
        })();
    </script>
</body>

</html>



